<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .val { font-size: 2rem; font-weight: bold; color: #4338ca; }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px">
        <h1>Dashboard Ejecutivo</h1>
        <a href="panel-admin.html" style="padding:10px 20px; background:white; text-decoration:none; color:black; border-radius:5px">Volver</a>
    </div>

    <div class="grid">
        <div class="card"><h3>Usuarios</h3><div class="val" id="kpiUsers">0</div></div>
        <div class="card"><h3>Evaluaciones</h3><div class="val" id="kpiEvals">0</div></div>
        <div class="card"><h3>Promedio Global</h3><div class="val" id="kpiAvg">0</div></div>
        <div class="card"><h3>Aprobados</h3><div class="val" id="kpiPass">0%</div></div>
    </div>

    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
        <div class="card"><canvas id="chart1"></canvas></div>
        <div class="card"><canvas id="chart2"></canvas></div>
    </div>

    <script>
        const SB_URL = 'https://xgvfcmadsprjyljtpooo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndmZjbWFkc3ByanlsanRwb29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODMxNjAsImV4cCI6MjA4MjE1OTE2MH0.XYBbKFE17PfyYMn2SNL5UJrCQmDRbimTQO0jpbX1Zd0';
        const sbClient = supabase.createClient(SB_URL, SB_KEY);

        window.onload = async function() {
            const { count: users } = await sbClient.from('usuarios').select('*', {count: 'exact', head: true}).neq('rol','admin');
            const { data: evals } = await sbClient.from('evaluaciones').select('*');
            
            document.getElementById('kpiUsers').innerText = users;
            document.getElementById('kpiEvals').innerText = evals.length;
            
            let sum=0, pass=0;
            evals.forEach(e => { sum+=e.nota; if(e.nota>=13) pass++; });
            document.getElementById('kpiAvg').innerText = (evals.length ? (sum/evals.length).toFixed(1) : 0);
            document.getElementById('kpiPass').innerText = (evals.length ? Math.round((pass/evals.length)*100) : 0) + "%";

            // Gr√°ficos
            new Chart(document.getElementById('chart1'), {
                type: 'bar',
                data: {
                    labels: ['Aprobados', 'Reprobados'],
                    datasets: [{ label: 'Evaluaciones', data: [pass, evals.length-pass], backgroundColor: ['#10b981', '#ef4444'] }]
                }
            });
        };
    </script>
</body>
</html>