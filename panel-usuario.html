<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geincos Academy | Mi Espacio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- VARIABLES DE DISE√ëO (Dise√±o Profesional Final) --- */
        :root { 
            --primary: #4338ca; 
            --primary-dark: #312e81;
            --primary-light: #6366f1; 
            --accent: #f59e0b; 
            --surface: #ffffff; 
            --bg-body: #f3f4f6; 
            --text-main: #1f2937; 
            --text-light: #6b7280; 
            --success: #10b981; 
            --danger: #ef4444; 
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }
        
        /* --- SIDEBAR --- */
        .sidebar { width: 280px; background: var(--surface); display: flex; flex-direction: column; padding: 30px 20px; border-right: 1px solid #e5e7eb; z-index: 50; flex-shrink: 0; transition: all 0.3s; }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; padding: 0 10px; }
        .brand i { font-size: 1.8rem; color: var(--primary); } 
        .brand span { font-size: 1.4rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        
        .menu-list { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 14px 20px; color: var(--text-light); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; font-size: 0.95rem; text-decoration: none; }
        .menu-item:hover { background-color: #eef2ff; color: var(--primary); }
        .menu-item.active { background: linear-gradient(90deg, var(--primary), var(--primary-light)); color: white; box-shadow: 0 4px 12px rgba(67, 56, 202, 0.3); }
        .menu-item i { width: 20px; text-align: center; font-size: 1.1rem; }
        
        .logout-btn { margin-top: auto; color: var(--danger); background: #fef2f2; border: 1px solid #fee2e2; }
        .logout-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
        .menu-badge { background: #ef4444; color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: auto; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: popIn 0.3s ease; }

        /* --- CONTENIDO PRINCIPAL --- */
        .main-content { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; scroll-behavior: smooth; }
        
        /* Hero Header */
        .hero-section { background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%); padding: 40px 50px 90px 50px; color: white; border-bottom-right-radius: 50px; box-shadow: var(--shadow-lg); flex-shrink: 0; position: relative; z-index: 1; }
        .hero-section h1 { font-size: 2.2rem; font-weight: 700; margin-bottom: 5px; letter-spacing: -0.5px; }
        .hero-section p { font-size: 1.05rem; opacity: 0.95; font-weight: 300; }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-left: 10px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        
        /* Wrapper del contenido */
        .content-wrapper { padding: 0 50px 50px; margin-top: -60px; flex: 1; position: relative; z-index: 10; }
        .content-section { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .content-section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        /* --- TARJETAS DE ESTAD√çSTICAS --- */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 20px; transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.03); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .stat-icon { width: 60px; height: 60px; background: #e0e7ff; color: var(--primary); border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; }
        .stat-info h4 { font-size: 0.9rem; color: var(--text-light); font-weight: 500; margin-bottom: 5px; }
        .stat-info h2 { font-size: 1.8rem; color: var(--text-main); font-weight: 800; line-height: 1; }

        /* --- M√ìDULOS (Carpetas) --- */
        .modules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; }
        .module-card { background: white; border-radius: 24px; box-shadow: var(--shadow-md); padding: 0; cursor: pointer; transition: all 0.3s; border: 1px solid rgba(0,0,0,0.04); overflow: hidden; display: flex; flex-direction: column; }
        .module-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); border-color: #e0e7ff; }
        .module-banner { height: 100px; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 3rem; position: relative; }
        .module-body { padding: 25px; flex: 1; display: flex; flex-direction: column; }
        .module-title-card { font-size: 1.2rem; font-weight: 700; color: var(--text-main); margin-bottom: 5px; }
        .module-meta { font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px; display: block; }
        .progress-track { width: 100%; height: 10px; background: #f1f5f9; border-radius: 5px; overflow: hidden; margin-top: auto; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 1s ease-in-out; border-radius: 5px; }
        .progress-text { font-size: 0.8rem; color: var(--text-light); font-weight: 600; margin-top: 8px; text-align: right; }

        /* --- VISTA DETALLE (CURSOS) --- */
        .module-detail-view { display: none; }
        .btn-back { background: white; border: 1px solid #e5e7eb; width: 45px; height: 45px; border-radius: 50%; box-shadow: var(--shadow-sm); cursor: pointer; color: var(--text-main); display: flex; align-items: center; justify-content: center; margin-bottom: 25px; transition: 0.2s; font-size: 1.1rem; }
        .btn-back:hover { transform: translateX(-5px); color: var(--primary); border-color: var(--primary); }
        
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .course-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-md); transition: all 0.3s; border: 1px solid rgba(0,0,0,0.03); display: flex; flex-direction: column; }
        .course-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .thumb-wrapper { height: 160px; background: #f8fafc; display: flex; justify-content: center; align-items: center; font-size: 3.5rem; color: var(--text-light); overflow: hidden; position: relative; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .type-badge { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; backdrop-filter: blur(4px); }
        .card-info { padding: 25px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: var(--text-main); line-height: 1.4; }
        
        /* BOTONES DE CURSO */
        .btn-start { width: 100%; padding: 12px; background: var(--text-main); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-top: auto; }
        .btn-start:hover { background: var(--primary); transform: translateY(-2px); }
        .btn-completed { width: 100%; padding: 12px; background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; border-radius: 12px; font-weight: 600; cursor: default; margin-top: auto; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-retest { width: 100%; padding: 12px; background: #fbbf24; color: #78350f; border: 1px solid #fcd34d; border-radius: 12px; cursor: pointer; font-weight: 700; margin-top: auto; animation: pulse 2s infinite; }

        /* --- CERTIFICADOS --- */
        .cert-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; }
        .cert-card { background: white; border-radius: 20px; overflow: hidden; border: 1px solid #e5e7eb; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow-md); position: relative; }
        .cert-card:hover { transform: translateY(-8px); border-color: var(--accent); box-shadow: 0 20px 40px rgba(245, 158, 11, 0.15); }
        .cert-top { height: 180px; background: linear-gradient(135deg, #1e293b, #0f172a); display: flex; justify-content: center; align-items: center; font-size: 5rem; color: var(--accent); position: relative; }
        .cert-top::after { content:''; position: absolute; width:100%; height:100%; background: url('https://www.transparenttextures.com/patterns/cubes.png'); opacity: 0.1; }
        .cert-body { padding: 25px; text-align: center; }
        .cert-title { font-weight: 700; font-size: 1.2rem; color: var(--text-main); margin-bottom: 5px; }
        .cert-subtitle { font-size: 0.85rem; color: var(--text-light); margin-bottom: 20px; }
        .btn-download { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-download:hover { background: var(--primary-light); transform: translateY(-2px); }

        /* --- RESULTADOS --- */
        .result-card { background: white; border-radius: 20px; padding: 25px; box-shadow: var(--shadow-md); transition: 0.3s; display: flex; justify-content: space-between; align-items: center; border-left: 8px solid #ccc; margin-bottom: 20px; }
        .result-card.pass { border-left-color: var(--success); } .result-card.fail { border-left-color: var(--danger); }
        .res-score { text-align: center; background: #f8fafc; padding: 15px 25px; border-radius: 16px; min-width: 120px; }
        .res-score h2 { margin: 0; font-size: 2rem; font-weight: 800; line-height: 1; }
        .btn-detail { background: transparent; border: 2px solid #e5e7eb; color: var(--text-main); padding: 8px 18px; border-radius: 25px; font-size: 0.85rem; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-detail:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- CHAT FULL SCREEN --- */
        .chat-full-container { background: white; border-radius: 24px; box-shadow: var(--shadow-lg); height: 75vh; display: flex; overflow: hidden; border: 1px solid #e5e7eb; }
        .chat-sidebar-list { width: 300px; background: #fff; border-right: 1px solid #f3f4f6; display: flex; flex-direction: column; }
        .chat-list-header { padding: 25px; border-bottom: 1px solid #f3f4f6; font-weight: 700; font-size: 1.1rem; }
        .chat-items { flex: 1; overflow-y: auto; padding: 15px; }
        .chat-contact { padding: 15px; border-radius: 16px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; margin-bottom: 8px; }
        .chat-contact:hover { background: #f8fafc; } .chat-contact.active { background: #eef2ff; border: 1px solid var(--primary-light); }
        .contact-avatar { width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: white; font-weight: 700; flex-shrink: 0; }
        
        .chat-area-main { flex: 1; display: flex; flex-direction: column; background: #f9fafb; }
        .chat-main-header { padding: 20px 30px; background: white; border-bottom: 1px solid #f3f4f6; font-weight: 700; height: 70px; display: flex; align-items: center; font-size: 1.1rem; }
        .chat-messages-box { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg-row { display: flex; width: 100%; margin-bottom: 5px; }
        .msg-row.me { justify-content: flex-end; } .msg-row.other { justify-content: flex-start; }
        .msg-bubble { max-width: 70%; padding: 12px 20px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-row.me .msg-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-row.other .msg-bubble { background: white; color: var(--text-main); border: 1px solid #e5e7eb; border-bottom-left-radius: 4px; }
        
        .chat-input-box { padding: 20px; background: white; border-top: 1px solid #f3f4f6; display: flex; gap: 15px; align-items: center; }
        .chat-input-field { flex: 1; background: #f1f5f9; border: 1px solid transparent; padding: 12px 25px; border-radius: 30px; outline: none; transition: 0.3s; font-size: 0.95rem; }
        .chat-input-field:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(67, 56, 202, 0.1); }
        .btn-send-msg { width: 45px; height: 45px; background: var(--primary); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 1.1rem; }
        .btn-send-msg:hover { transform: scale(1.1); }

        /* --- SIMULADORES --- */
        .sim-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .sim-card { background: white; border-radius: 24px; overflow: hidden; box-shadow: var(--shadow-md); transition: all 0.3s; border: 1px solid rgba(0,0,0,0.03); display: flex; flex-direction: column; }
        .sim-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); }
        .sim-header-bg { height: 160px; background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 4rem; }
        .sim-body { padding: 25px; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .btn-sim-play { width: 100%; padding: 14px; background: #1e293b; color: white; border: none; border-radius: 16px; font-weight: 600; cursor: pointer; margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-sim-play:hover { background: var(--primary); }

        /* --- RANKING --- */
        .rank-row { display: flex; align-items: center; background: white; padding: 18px 30px; border-radius: 16px; margin-bottom: 12px; box-shadow: var(--shadow-sm); border: 1px solid #f1f5f9; transition: 0.2s; }
        .rank-row:hover { transform: scale(1.01); box-shadow: var(--shadow-md); }
        .rank-pos { font-size: 1.5rem; font-weight: 800; width: 60px; text-align: center; color: #cbd5e1; }
        .rank-points { margin-left: auto; font-weight: 800; color: var(--primary); background: #e0e7ff; padding: 6px 18px; border-radius: 12px; font-size: 1.1rem; }

        /* --- MODALES --- */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.9); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { width: 95%; max-width: 1000px; height: 90vh; background: white; border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-body { flex: 1; background: black; overflow-y: auto; position: relative; }
        .modal-body.exam { background: #f8fafc; padding: 50px; }
        
        .exam-card { background: white; padding: 30px; border-radius: 20px; margin-bottom: 25px; border-left: 6px solid var(--primary); box-shadow: var(--shadow-md); }
        .exam-opt { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #f1f5f9; border-radius: 12px; margin-top: 10px; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .exam-opt:hover { background: #eef2ff; border-color: var(--primary-light); }
        .exam-opt input { width: 20px; height: 20px; accent-color: var(--primary); }

        @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(251,191,36,0.7)} 70%{box-shadow:0 0 0 10px rgba(251,191,36,0)} 100%{box-shadow:0 0 0 0 rgba(251,191,36,0)} }
        @keyframes popIn { from{transform:scale(0);} to{transform:scale(1);} }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand"><i class="fas fa-graduation-cap"></i> <span>Academy</span></div>
        <div class="menu-list">
            <div class="menu-item active" onclick="nav('home', this)"><i class="fas fa-layer-group"></i> Mi Aprendizaje</div>
            <div class="menu-item" onclick="nav('results', this); loadResults()"><i class="fas fa-clipboard-list"></i> Resultados</div>
            <div class="menu-item" onclick="nav('certs', this); loadCerts()"><i class="fas fa-certificate"></i> Mis Certificados</div>
            <div class="menu-item" onclick="nav('messages', this)"><i class="fas fa-comment-alt"></i> Mensajes <div class="menu-badge" id="menuBadge">0</div></div>
            <div class="menu-item" onclick="nav('simulador', this)"><i class="fas fa-gamepad"></i> Entrenamiento</div>
            <div class="menu-item" onclick="nav('duels', this)"><i class="fas fa-bolt"></i> Duelos PvP</div>
            <div class="menu-item" onclick="nav('ranking', this)"><i class="fas fa-trophy"></i> Tabla de L√≠deres</div>
        </div>
        <div class="menu-item logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</div>
    </div>

    <div class="main-content">
        <div class="hero-section">
            <h1>Hola, <span id="username">...</span> üëã</h1>
            <p>Bienvenido a tu espacio de crecimiento. <span id="groupTag" class="user-pill">...</span></p>
        </div>
        <div class="content-wrapper">
            
            <div id="home" class="content-section active">
                <div class="stats-container">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-book-open"></i></div><div><h4>Asignados</h4><h2 id="stTotal">0</h2></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-chart-pie"></i></div><div><h4>Promedio</h4><h2 id="stAvg">0.0</h2></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-crown"></i></div><div><h4>Racha</h4><h2>3 D√≠as</h2></div></div>
                </div>
                
                <div id="modulesGrid" class="modules-grid">Cargando...</div>
                
                <div id="detailView" class="module-detail-view">
                    <button class="btn-back" onclick="closeDetail()"><i class="fas fa-arrow-left"></i></button>
                    <h2 id="modTitleName" style="margin-bottom:25px; font-size:1.8rem">M√≥dulo</h2>
                    <div id="coursesGrid" class="courses-grid"></div>
                </div>
            </div>

            <div id="results" class="content-section">
                <h2 style="margin-bottom:30px">üìù Historial de Notas</h2>
                <div id="resList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:25px"></div>
            </div>

            <div id="certs" class="content-section">
                <h2 style="margin-bottom:30px; color:var(--primary)">üèÜ Mis Logros Certificados</h2>
                <div id="certList" class="cert-grid"></div>
            </div>

            <div id="messages" class="content-section">
                <h2 style="margin-bottom:30px">Soporte T√©cnico</h2>
                <div class="chat-full-container">
                    <div class="chat-sidebar-list">
                        <div class="chat-list-header">Chats Activos</div>
                        <div class="chat-items">
                            <div class="chat-contact active" onclick="setChat('Admin')">
                                <div class="contact-avatar" style="background:#ef4444"><i class="fas fa-headset"></i></div>
                                <div><b>Soporte T√©cnico</b><br><small>Administrador</small></div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-area-main">
                        <div class="chat-main-header">Chat con Soporte</div>
                        <div class="chat-messages-box" id="chatBox">
                            <div style="text-align:center; margin-top:50px; color:#9ca3af"><i class="fas fa-comments" style="font-size:3rem"></i><p>Tus mensajes aparecer√°n aqu√≠.</p></div>
                        </div>
                        <div class="chat-input-box">
                            <input id="msgInput" class="chat-input-field" placeholder="Escribe tu mensaje..." onkeypress="if(event.key==='Enter') sendMsg()">
                            <button class="btn-send-msg" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="simulador" class="content-section">
                <h2 style="margin-bottom:30px">Entrenamiento Pr√°ctico</h2>
                <div id="simList" class="sim-grid"></div>
            </div>

            <div id="duels" class="content-section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px"><h2>Duelos PvP</h2><button class="btn-start" style="width:auto;margin:0" onclick="createDuel()">+ Nuevo Duelo</button></div>
                <div id="duelsList"></div>
            </div>
            <div id="ranking" class="content-section">
                <h2 style="margin-bottom:30px">Tabla de L√≠deres</h2>
                <div id="rankList" style="background:white;padding:30px;border-radius:24px;box-shadow:var(--shadow-md)"></div>
            </div>

        </div>
    </div>

    <div class="modal" id="appModal">
        <div class="modal-box">
            <div style="padding:20px 30px; display:flex; justify-content:space-between; background:white; border-bottom:1px solid #f1f5f9; align-items:center">
                <span id="mTitle" style="font-weight:700; font-size:1.1rem">Curso</span>
                <button onclick="closeModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:#9ca3af">‚úï</button>
            </div>
            <div id="mBody" class="modal-body"></div>
            <div id="mFooter" style="padding:20px; background:white; text-align:right; border-top:1px solid #f1f5f9; display:none">
                <button id="btnAction" class="btn-start" style="width:auto; padding:12px 40px">Acci√≥n</button>
            </div>
        </div>
    </div>

    <div class="modal" id="simModal">
        <div style="width:360px; height:750px; background:white; border:14px solid #1f2937; border-radius:45px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 30px 60px rgba(0,0,0,0.5)">
            <div style="background:#111827; color:white; padding:20px; display:flex; justify-content:space-between; align-items:center"><span>Simulador</span><button onclick="document.getElementById('simModal').style.display='none'" style="background:none; border:none; color:white; font-size:1.2rem">‚úï</button></div>
            <div id="simContent" style="flex:1; background:#f3f4f6; padding:25px; overflow-y:auto; display:flex; flex-direction:column; gap:15px;"></div>
            <div id="simOpts" style="background:white; border-top:1px solid #e5e7eb"></div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://xgvfcmadsprjyljtpooo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndmZjbWFkc3ByanlsanRwb29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODMxNjAsImV4cCI6MjA4MjE1OTE2MH0.XYBbKFE17PfyYMn2SNL5UJrCQmDRbimTQO0jpbX1Zd0';
        const sbClient = supabase.createClient(SB_URL, SB_KEY);
        const user = localStorage.getItem('usuarioActual');
        const group = localStorage.getItem('usuarioGrupo') || 'General';
        
        if(!user) window.location.href='index.html';
        document.getElementById('username').innerText = user;
        document.getElementById('groupTag').innerText = group;

        let myEvals = [], groupedModules = {}, currentCourse = '', simData = [], simStep = 0, chatMsgs = [];
        const audioNotif = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        window.onload = () => { loadData(); initChat(); setInterval(checkMsg, 3000); };

        function nav(id, el) { 
            document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
            el.classList.add('active');
        }
        function logout() { localStorage.clear(); window.location.href='index.html'; }
        function closeModal() { document.getElementById('appModal').style.display='none'; document.getElementById('mBody').innerHTML=''; }

        // --- 1. CARGA DE DATOS ---
        async function loadData() {
            // Evaluaciones
            const { data: evals } = await sbClient.from('evaluaciones').select('*').eq('usuario', user).order('created_at', {ascending:true});
            myEvals = evals || [];
            
            // Promedios
            let sum = myEvals.reduce((a,b)=>a+b.nota,0);
            let avg = myEvals.length ? (sum/myEvals.length).toFixed(1) : 0;
            document.getElementById('stAvg').innerText = avg;

            // Cursos
            const { data: assign } = await sbClient.from('asignaciones').select('cursos_json').eq('usuario', user).maybeSingle();
            if(assign) {
                const titles = JSON.parse(assign.cursos_json);
                document.getElementById('stTotal').innerText = titles.length;
                const { data: courses } = await sbClient.from('cursos').select('*').in('titulo', titles);
                
                // Agrupar
                groupedModules = {};
                courses.forEach(c => {
                    if(c.tipo === 'simulador') return; 
                    let m = c.modulo || 'General';
                    if(!groupedModules[m]) groupedModules[m] = [];
                    groupedModules[m].push(c);
                });

                renderModules();
                renderSims(courses.filter(c => c.tipo === 'simulador'));
            }
            loadRanking(); loadDuels();
        }

        // --- 2. RENDERIZADO DE M√ìDULOS ---
        function renderModules() {
            let h = '';
            for(let m in groupedModules) {
                let total = groupedModules[m].length;
                let done = 0;
                groupedModules[m].forEach(c => { if(myEvals.find(e => e.curso === c.titulo)) done++; });
                let pct = total ? Math.round((done/total)*100) : 0;
                h += `<div class="module-card" onclick="openDetail('${m}')">
                    <div class="module-banner"><i class="fas fa-folder-open"></i></div>
                    <div class="module-body"><h4 class="module-title-card">${m}</h4><small class="module-meta">${total} Cursos</small>
                    <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                    <div class="progress-text">${pct}% Completado</div></div>
                </div>`;
            }
            document.getElementById('modulesGrid').innerHTML = h;
        }

        function openDetail(m) {
            document.getElementById('modulesGrid').style.display='none';
            document.getElementById('detailView').style.display='block';
            document.getElementById('modTitleName').innerText = m;
            let courses = groupedModules[m];
            let h = '';
            courses.forEach(c => {
                let courseEvals = myEvals.filter(e => e.curso === c.titulo);
                let last = courseEvals.length ? courseEvals[courseEvals.length-1] : null;
                let btn = `<button class="btn-start" onclick="launch('${c.id}','${c.tipo}','${c.video}','${c.titulo}')">Acceder</button>`;
                
                if(c.tipo === 'examen' && last) {
                    if(last.retest_active) btn = `<button class="btn-retest" onclick="launch('${c.id}','${c.tipo}','${c.video}','${c.titulo}', true)">üîÑ Retest Disponible</button>`;
                    else btn = `<button class="btn-completed">‚úî Nota: ${last.nota}</button>`;
                }
                
                let vidId = c.video ? (c.video.split('v=')[1]||c.video.split('/').pop()) : '';
                let thumb = vidId ? `<img src="https://img.youtube.com/vi/${vidId}/hqdefault.jpg" class="thumb-img">` : `<div class="thumb-wrapper"><i class="fas fa-file-alt"></i></div>`;
                if(c.tipo === 'examen') thumb = `<div class="thumb-wrapper" style="color:#10b981; background:#ecfdf5"><i class="fas fa-clipboard-check"></i></div>`;

                h += `<div class="course-card"><div class="thumb-wrapper">${thumb}<span class="type-badge">${c.tipo.toUpperCase()}</span></div><div class="card-info"><h4 class="card-title">${c.titulo}</h4>${btn}</div></div>`;
            });
            document.getElementById('coursesGrid').innerHTML = h;
        }
        function closeDetail() { document.getElementById('detailView').style.display='none'; document.getElementById('modulesGrid').style.display='grid'; }

        // --- 3. EXAMEN & PLAYER ---
        function launch(id, type, url, title, isRetest=false) {
            currentCourse = title; document.getElementById('mTitle').innerText = title;
            let area = document.getElementById('mBody'); document.getElementById('appModal').style.display='flex';
            const footer = document.getElementById('mFooter'); const btn = document.getElementById('btnAction');
            area.className = 'modal-body'; footer.style.display='none'; area.innerHTML='';

            let courseEvals = myEvals.filter(e => e.curso === title);
            let last = courseEvals.length ? courseEvals[courseEvals.length-1] : null;

            if (type === 'examen') {
                if (last && !last.retest_active && !isRetest) { area.innerHTML = `<div style="text-align:center;padding:50px;color:white"><h2>Examen Completado</h2></div>`; return; }
                area.innerHTML = `<div style="text-align:center;padding:50px;color:white"><i class="fas fa-file-alt" style="font-size:4rem; margin-bottom:20px; opacity:0.8"></i><h2>Evaluaci√≥n Te√≥rica</h2><p>Tienes 10 minutos.</p></div>`;
                footer.style.display='block'; btn.innerText='Comenzar'; btn.onclick=renderExam;
            } else if (type === 'video') {
                let vidId = url.split('v=')[1]||url.split('/').pop();
                area.innerHTML = `<div class="video-container"><div class="video-responsive"><iframe src="https://www.youtube.com/embed/${vidId}" frameborder="0" allowfullscreen></iframe></div></div>`;
                if(!last || last.retest_active || isRetest) {
                    footer.style.display='block'; btn.innerText='Esperando...'; btn.disabled=true; btn.style.opacity=0.5;
                    setTimeout(()=>{ btn.disabled=false; btn.style.opacity=1; btn.innerText='Realizar Examen'; btn.onclick=renderExam; }, 5000); 
                }
            } else if (type === 'pdf') {
                area.innerHTML = `<iframe width="100%" height="100%" src="${url}"></iframe>`;
            }
        }

        async function renderExam() {
            const body = document.getElementById('mBody'); body.className='modal-body exam';
            document.getElementById('mFooter').style.display='none';
            const { data: qs } = await sbClient.from('preguntas').select('*').eq('curso', currentCourse);
            if(!qs || !qs.length) { body.innerHTML='<h3>Sin preguntas configuradas.</h3>'; return; }
            let h = `<div class="exam-container"><h2 style="margin-bottom:30px; text-align:center">${currentCourse}</h2>`;
            qs.forEach((q,i) => {
                h+=`<div class="exam-card"><p class="exam-question"><b>${i+1}. ${q.pregunta}</b></p>
                <div class="exam-options">
                <label class="exam-opt"><input type="radio" name="q${q.id}" value="op1"> ${q.opcion1}</label>
                <label class="exam-opt"><input type="radio" name="q${q.id}" value="op2"> ${q.opcion2}</label>
                <label class="exam-opt"><input type="radio" name="q${q.id}" value="op3"> ${q.opcion3}</label>
                </div></div>`;
            });
            h+=`<button class="btn-start" style="max-width:300px; display:block; margin:30px auto" onclick="submitExam()">Enviar Respuestas</button></div>`;
            body.innerHTML = h;
        }

        async function submitExam() {
            const { data: qs } = await sbClient.from('preguntas').select('*').eq('curso', currentCourse);
            let score = 0, total = 0, detalles = [];
            qs.forEach(q => {
                total += 2; const sel = document.querySelector(`input[name="q${q.id}"]:checked`);
                let st = "INCORRECTO", val = "Sin respuesta";
                if(sel) { val = sel.parentElement.innerText; if(sel.value === q.correcta) { score+=2; st="CORRECTO"; } }
                detalles.push(`[P: ${q.pregunta} | R: ${val} (${st})]`);
            });
            let final = Math.round((score/total)*20);
            
            await sbClient.from('evaluaciones').insert([{ usuario: user, curso: currentCourse, nota: final, grupo: group, detalle: detalles.join(" ||| "), retest_active: false }]);
            await sbClient.from('evaluaciones').update({retest_active:false}).eq('usuario',user).eq('curso',currentCourse).eq('retest_active',true);
            const {data:evs} = await sbClient.from('evaluaciones').select('nota').eq('usuario',user);
            let sum=evs.reduce((a,b)=>a+b.nota,0); let gAvg=(sum/evs.length).toFixed(1);
            await sbClient.from('usuarios').update({promedio:gAvg}).eq('usuario',user);
            alert('Nota: '+final); location.reload();
        }

        // --- 4. CERTIFICADOS (PDF COORDENADAS PERFECTAS) ---
        async function loadCerts() {
            const c = document.getElementById('certList'); c.innerHTML='Cargando...';
            const { data } = await sbClient.from('usuarios').select('certificados_json').eq('usuario', user).single();
            let certs = []; try { certs = JSON.parse(data.certificados_json||'[]'); } catch(e){}
            
            if(!certs.length) { c.innerHTML='<p style="grid-column:1/-1;text-align:center;color:#999">A√∫n no tienes certificados aprobados por el administrador.</p>'; return; }
            
            let h = '';
            certs.forEach(t => {
                h += `<div class="cert-card" onclick="genPDF('${t}')">
                    <div class="cert-top"><i class="fas fa-award"></i></div>
                    <div class="cert-body"><h4 class="cert-title">${t}</h4><p class="cert-subtitle">Certificado Oficial</p><button class="btn-download"><i class="fas fa-download"></i> Descargar PDF</button></div>
                </div>`;
            });
            c.innerHTML = h;
        }

        async function genPDF(title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', format: 'a4' });
            const img = new Image();
            img.src = 'certificado_bg.png'; // ASEGURATE DE TENER ESTA IMAGEN
            
            img.onload = function() {
                doc.addImage(img, 'PNG', 0, 0, 297, 210);
                const w = 297; 
                const center = w/2;

                // 1. CARGO (Arriba - Y=85)
                doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.setTextColor(67, 56, 202); 
                doc.text("ESPECIALISTA EN " + title.toUpperCase(), center, 85, {align:"center"});

                // 2. NOMBRE (Centro - Y=135)
                doc.setFont("times", "italic"); doc.setFontSize(40); doc.setTextColor(0, 0, 0);
                doc.text(user, center, 135, {align:"center"});

                // 3. PARCHE BLANCO PARA "COBRANZAS" (Opcional, si la imagen lo tiene)
                // doc.setFillColor(255,255,255); doc.rect(40, 160, 217, 12, 'F'); // DESCOMENTAR SI ES NECESARIO

                // 4. FIRMA (Derecha - X=240, Y=192) - SIN L√çNEA
                doc.setFont("helvetica", "normal"); doc.setFontSize(11); doc.setTextColor(50, 50, 50);
                doc.text("Hugo Tuesta Villar", 240, 192, {align:"center"});
                doc.setFontSize(9);
                doc.text("Gerente General", 240, 198, {align:"center"});
                
                doc.save(`Certificado_${title}.pdf`);
            };
            img.onerror = () => alert("Falta la imagen certificado_bg.png");
        }

        // --- 5. RESULTADOS ---
        async function loadResults() {
            const c = document.getElementById('resList'); c.innerHTML='Cargando...';
            const { data: evs } = await sbClient.from('evaluaciones').select('*').eq('usuario', user).order('created_at', {ascending:false});
            if(!evs.length) { c.innerHTML='<p style="grid-column:1/-1;text-align:center">Sin resultados.</p>'; return; }
            let h = '';
            evs.forEach(e => {
                let color = e.nota >= 14 ? 'var(--success)' : 'var(--danger)';
                let det = encodeURIComponent(e.detalle||'');
                h += `<div class="result-card" style="border-left-color:${color}"><div><h4>${e.curso}</h4><small style="color:#666">${new Date(e.created_at).toLocaleDateString()}</small><br><button class="btn-detail" onclick="viewDet('${det}')">Ver Correcci√≥n</button></div><div class="res-score"><h2 style="color:${color}">${e.nota}</h2></div></div>`;
            });
            c.innerHTML = h;
        }
        function viewDet(enc) {
            let txt = decodeURIComponent(enc);
            document.getElementById('mTitle').innerText = 'Correcci√≥n';
            document.getElementById('appModal').style.display='flex';
            document.getElementById('mFooter').style.display='none';
            let html = '<div style="padding:20px; background:#f3f4f6">';
            txt.split(" ||| ").forEach(line => {
                let color = line.includes("CORRECTO") ? "#dcfce7" : "#fee2e2";
                html += `<div style="background:${color}; padding:15px; margin-bottom:10px; border-radius:10px; font-size:0.9rem; border:1px solid rgba(0,0,0,0.05)">${line}</div>`;
            });
            html += '</div>';
            document.getElementById('mBody').innerHTML = html;
        }

        // --- 6. EXTRAS ---
        function renderSims(list) { let h=''; list.forEach(s=>{ h+=`<div class="sim-card"><div class="sim-header-bg"><i class="fas fa-gamepad"></i></div><div class="sim-body"><h4 class="module-title-card">${s.titulo}</h4><button class="btn-sim-play" onclick="playSim('${encodeURIComponent(s.data_juego)}')"><i class="fas fa-play"></i> Jugar</button></div></div>`; }); document.getElementById('simList').innerHTML=h; }
        function playSim(json){ simData=JSON.parse(decodeURIComponent(json)); simStep=0; document.getElementById('simModal').style.display='flex'; runSimStep(); }
        function runSimStep(){ let s=simData[simStep]; if(!s){alert("Fin");document.getElementById('simModal').style.display='none';return;} document.getElementById('simContent').innerHTML=`<div class="client-msg">${s.cliente}</div>`; let h=''; s.opciones.forEach((o,i)=>h+=`<div class="option-btn" onclick="checkSim(${i})">${o}</div>`); document.getElementById('simOpts').innerHTML=h; }
        function checkSim(i){ if(i==simData[simStep].correcta){simStep++;runSimStep();}else alert("Incorrecto"); }
        async function loadRanking(){ const {data}=await sbClient.from('usuarios').select('usuario,promedio').eq('etiqueta',group).order('promedio',{ascending:false}).limit(10); let h=''; data.forEach((u,i)=>h+=`<div class="rank-row"><div class="rank-pos">${i+1}</div><div>${u.usuario}</div><div class="rank-points">${u.promedio}</div></div>`); document.getElementById('rankList').innerHTML=h; }
        async function loadDuels(){ const {data}=await sbClient.from('duelos').select('*').order('created_at',{ascending:false}); let h=''; data.forEach(d=>h+=`<div style="padding:15px;background:white;margin-bottom:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05)"><b>${d.retador} vs ${d.oponente}</b><br><small>${d.estado}</small></div>`); document.getElementById('duelsList').innerHTML=h; }
        async function createDuel(){ let op=prompt("Oponente:"); if(op) await sbClient.from('duelos').insert([{retador:user, oponente:op, estado:'PENDIENTE'}]); loadDuels(); }

        // --- 7. CHAT ---
        function initChat(){ sbClient.channel('chat').on('postgres_changes',{event:'INSERT',schema:'public',table:'chat'},p=>{ if(p.new.destinatario===user){ chatMsgs.push(p.new); renderChat(); audioNotif.play().catch(()=>{}); } }).subscribe(); checkMsg(); }
        async function checkMsg(){ const {data}=await sbClient.from('chat').select('*').or(`and(remitente.eq.Admin,destinatario.eq.${user}),and(remitente.eq.${user},destinatario.eq.Admin)`).order('created_at',{ascending:true}); chatMsgs=data; renderChat(); }
        function renderChat(){ const b=document.getElementById('chatBox'); b.innerHTML=''; chatMsgs.forEach(m=>{ let cls=m.remitente===user?'me':'other'; b.innerHTML+=`<div class="msg-row ${cls}"><div class="msg-bubble">${m.mensaje}</div></div>`; }); b.scrollTop=b.scrollHeight; }
        async function sendMsg(){ const t=document.getElementById('msgInput').value; if(!t)return; await sbClient.from('chat').insert([{remitente:user, destinatario:'Admin', mensaje:t, leido:false}]); document.getElementById('msgInput').value=''; checkMsg(); }
    </script>
</body>
</html>