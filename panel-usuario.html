<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Academy | Panel Estudiante</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --primary-light: #6366f1; --primary-soft: #eef2ff;
            --bg-body: #f8fafc; --surface: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --radius: 20px;
            --shadow-soft: 0 10px 40px -10px rgba(79, 70, 229, 0.1);
            --shadow-hover: 0 20px 40px -10px rgba(79, 70, 229, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--surface); padding: 30px 20px; display: flex; flex-direction: column; z-index: 50; box-shadow: 5px 0 30px rgba(0,0,0,0.02); }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; padding: 0 10px; font-weight: 800; font-size: 1.4rem; color: var(--primary); letter-spacing: -0.5px; }
        .menu-list { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .menu-item { padding: 14px 18px; border-radius: 12px; cursor: pointer; color: var(--text-muted); font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 15px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .menu-item:hover { background: var(--primary-soft); color: var(--primary); transform: translateX(5px); }
        .menu-item.active { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; box-shadow: 0 8px 20px -5px rgba(79, 70, 229, 0.4); }
        
        /* MAIN CONTENT */
        .main-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        .hero-section { background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%); padding: 40px 50px 100px; color: white; border-bottom-right-radius: 60px; position: relative; overflow: hidden; }
        .hero-title h1 { font-size: 2rem; font-weight: 800; margin-bottom: 5px; }
        .hero-title p { opacity: 0.9; font-weight: 400; }
        .group-badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); }

        .content-wrapper { padding: 0 50px 50px; margin-top: -70px; position: relative; z-index: 10; }
        .content-section { display: none; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); } 
        .content-section.active { display: block; }
        @keyframes slideUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }

        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: var(--surface); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow-soft); display: flex; align-items: center; gap: 20px; transition: 0.3s; border: 1px solid white; }
        .stat-icon { width: 60px; height: 60px; background: var(--primary-soft); color: var(--primary); border-radius: 18px; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; }
        
        .modules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .module-card { background: var(--surface); border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow-soft); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; border-top: 5px solid var(--primary); display: flex; flex-direction: column; justify-content: space-between; height: 220px; }
        .module-card:hover { transform: translateY(-8px) scale(1.02); }
        .progress-container { background: #f1f5f9; height: 6px; border-radius: 10px; overflow: hidden; margin-top: auto; }
        .progress-bar { height: 100%; background: var(--success); width: 0%; border-radius: 10px; }

        /* RESULTADOS (TARJETAS) */
        .res-grid { display: grid; gap: 20px; }
        .res-card { background: white; border-radius: 18px; padding: 25px; box-shadow: var(--shadow-soft); display: flex; align-items: center; justify-content: space-between; position: relative; overflow: hidden; transition: 0.3s; border: 1px solid #f1f5f9; }
        .res-card.pass { border-left: 5px solid var(--success); }
        .res-card.fail { border-left: 5px solid var(--danger); }
        .res-info h4 { font-size: 1.1rem; font-weight: 800; margin-bottom: 5px; color: var(--text-main); }
        .res-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-muted); align-items: center; }
        .res-score { text-align: center; background: var(--bg-body); padding: 10px 20px; border-radius: 14px; }
        .res-score h2 { margin: 0; font-size: 1.8rem; font-weight: 800; line-height: 1; }
        .res-btn { padding: 8px 16px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; background: white; border: 2px solid #e2e8f0; color: var(--text-muted); margin-top: 10px; }
        .res-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* MODAL */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.8); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-card { width: 90%; max-width: 850px; height: 85vh; background: white; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 20px 30px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .btn-close { background: #f1f5f9; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; }
        .modal-body { flex: 1; overflow-y: auto; background: #f8fafc; padding: 40px; }
        
        /* ESTILOS PARA FEEDBACK DETALLADO */
        .feedback-box { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 20px; border-radius: 12px; line-height: 1.6; font-size: 0.95rem; margin-bottom: 25px; }
        .imp-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        .imp-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .imp-title { font-weight: 800; color: var(--danger); font-size: 1rem; }
        .imp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 768px) { .imp-grid { grid-template-columns: 1fr; } }
        .imp-col-bad { background: #fef2f2; border-radius: 12px; padding: 15px; border: 1px dashed #ef4444; }
        .imp-col-good { background: #f0fdf4; border-radius: 12px; padding: 15px; border: 1px solid #10b981; }
        .imp-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 800; margin-bottom: 8px; display: block; }
        .imp-text { font-style: italic; font-size: 0.95rem; line-height: 1.5; color: #334155; }
        .imp-badge { display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; margin-bottom: 5px; }

        /* OTROS */
        .cert-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .cert-card { background: white; border-radius: 20px; padding: 30px; text-align: center; box-shadow: var(--shadow-soft); border: 1px solid #f1f5f9; position: relative; cursor: pointer; transition: 0.3s; }
        .cert-card:hover { transform: translateY(-5px); }
        .cert-icon { width: 60px; height: 60px; background: #fffbeb; color: #d97706; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; margin: 0 auto 15px; }
        .rp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .rp-card { background: white; border-radius: 20px; padding: 25px; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 15px; border-left: 5px solid #ec4899; }
        .btn-start-rp { padding: 12px; border-radius: 12px; border: none; background: #ec4899; color: white; font-weight: 700; cursor: pointer; text-decoration: none; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; margin-top: auto; }
        .btn-start-rp:hover { background: #be185d; }
        .rank-row { display: flex; align-items: center; padding: 15px 20px; margin-bottom: 10px; border-radius: 16px; background: white; border: 1px solid #f1f5f9; }
        .rank-pos { width: 40px; font-size: 1.2rem; font-weight: 900; color: #94a3b8; }
        .rank-pts { margin-left: auto; font-weight: 800; color: var(--primary); background: #eef2ff; padding: 5px 12px; border-radius: 10px; }
        .chat-frame { display: flex; height: 70vh; background: white; border-radius: 24px; overflow: hidden; border: 1px solid #f1f5f9; }
        .chat-zone { flex: 1; display: flex; flex-direction: column; }
        .chat-body { flex: 1; padding: 30px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 75%; padding: 12px 18px; border-radius: 18px; font-size: 0.95rem; }
        .msg.me { align-self: flex-end; background: var(--primary); color: white; }
        .msg.other { align-self: flex-start; background: white; border: 1px solid #e2e8f0; }
        .module-detail-view { display: none; }
        .course-item { background: white; padding: 20px; border-radius: 16px; display: flex; align-items: center; gap: 20px; box-shadow: var(--shadow-soft); margin-bottom: 15px; }
        .btn-action { padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; background: var(--text-main); color: white; margin-left: auto; }
        .btn-back { background: white; width: 45px; height: 45px; border-radius: 14px; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 20px; border: 1px solid #e2e8f0; font-size: 1.1rem; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand"><i class="fas fa-graduation-cap"></i><span>Academy</span></div>
        <div class="menu-list">
            <div class="menu-item active" onclick="nav('home', this)"><i class="fas fa-th-large"></i> Mi Aprendizaje</div>
            <div class="menu-item" onclick="nav('results', this); loadResults()"><i class="fas fa-clipboard-list"></i> Resultados</div>
            <div class="menu-item" onclick="nav('certs', this); loadCerts()"><i class="fas fa-certificate"></i> Certificados</div>
            <div class="menu-item" onclick="nav('messages', this)"><i class="fas fa-comments"></i> Mensajes</div>
            <div class="menu-item" onclick="nav('sims', this)"><i class="fas fa-gamepad"></i> Simuladores</div>
            <div class="menu-item" onclick="nav('iaroleplay', this); loadIARoleplays()"><i class="fas fa-robot"></i> IA Roleplay</div>
            <div class="menu-item" onclick="nav('duels', this)"><i class="fas fa-bolt"></i> Duelos PvP</div>
            <div class="menu-item" onclick="nav('ranking', this)"><i class="fas fa-trophy"></i> Ranking</div>
        </div>
        <div class="menu-item" style="margin-top:auto; color:var(--danger)" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</div>
    </div>

    <div class="main-content">
        <div class="hero-section">
            <div class="hero-title">
                <h1>Hola, <span id="username">User</span> üëã</h1>
                <p>Bienvenido a tu espacio. <span id="groupTag" class="group-badge">...</span></p>
            </div>
        </div>
        
        <div class="content-wrapper">
            <div id="home" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-book-open"></i></div><div><h4 style="margin:0;color:#64748b">Asignados</h4><h2 id="stTotal" style="margin:0;font-size:1.8rem">0</h2></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-chart-pie"></i></div><div><h4 style="margin:0;color:#64748b">Promedio</h4><h2 id="stAvg" style="margin:0;font-size:1.8rem">0.0</h2></div></div>
                </div>
                <div id="modulesGrid" class="modules-grid">Cargando...</div>
                <div id="detailView" class="module-detail-view">
                    <button class="btn-back" onclick="closeDetail()"><i class="fas fa-arrow-left"></i></button>
                    <h2 id="modTitleName" style="margin-bottom:30px; font-weight:800">M√≥dulo</h2>
                    <div id="coursesGrid"></div>
                </div>
            </div>

            <div id="results" class="content-section">
                <h2 style="margin-bottom:30px; font-weight:800">Historial de Evaluaciones</h2>
                <div id="resList" class="res-grid"></div>
            </div>

            <div id="certs" class="content-section">
                <h2 style="margin-bottom:30px; font-weight:800">Mis Logros</h2>
                <div id="certList" class="cert-grid"></div>
            </div>

            <div id="ranking" class="content-section">
                <h2 style="margin-bottom:30px; font-weight:800">üèÜ Top Estudiantes</h2>
                <div id="rankList" style="background:white; border-radius:24px; padding:20px; box-shadow:var(--shadow-soft)"></div>
            </div>

            <div id="iaroleplay" class="content-section"><h2 style="margin-bottom:30px">Entrenamiento IA</h2><div id="rpList" class="rp-grid"></div></div>
            <div id="messages" class="content-section"><h2 style="margin-bottom:30px">Soporte</h2><div class="chat-frame"><div class="chat-zone"><div class="chat-body" id="chatBox"></div><div style="padding:20px;border-top:1px solid #eee;display:flex;gap:10px"><input id="msgInput" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:20px"><button onclick="sendMsg()" class="btn-action">Enviar</button></div></div></div></div>
            <div id="sims" class="content-section"><h2 style="margin-bottom:30px">Simuladores</h2><div id="simList" class="sim-grid"></div></div>
            <div id="duels" class="content-section"><h2>Duelos PvP</h2><button class="btn-action" onclick="createDuel()">+ Nuevo</button><div id="duelsList" style="margin-top:20px"></div></div>
        </div>
    </div>

    <div class="modal-overlay" id="appModal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="mTitle">Info</h3>
                <button class="btn-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="mBody" class="modal-body"></div>
            <div id="mFooter" style="padding:20px; display:none; text-align:right; background:white; border-top:1px solid #e2e8f0">
                <button id="btnAction" class="btn-action">Acci√≥n</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://xgvfcmadsprjyljtpooo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndmZjbWFkc3ByanlsanRwb29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODMxNjAsImV4cCI6MjA4MjE1OTE2MH0.XYBbKFE17PfyYMn2SNL5UJrCQmDRbimTQO0jpbX1Zd0';
        const sbClient = supabase.createClient(SB_URL, SB_KEY);
        const user = localStorage.getItem('usuarioActual');
        
        if(!user) window.location.href='index.html';
        document.getElementById('username').innerText = user;

        let myEvals=[], groupedModules={}, currentCourse='', availableSims=[], simData=[], simStep=0, chatMsgs=[], userCertName=user;

        window.onload = () => { loadData(); initChat(); setInterval(checkMsg, 3000); };
        function nav(id, el) { document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); el.classList.add('active'); }
        function logout() { localStorage.clear(); window.location.href='index.html'; }
        function closeModal() { document.getElementById('appModal').style.display='none'; document.getElementById('mBody').innerHTML=''; }

        async function loadData() {
            const { data: uData } = await sbClient.from('usuarios').select('correo, etiqueta').eq('usuario', user).single();
            if(uData) { if(uData.correo) userCertName = uData.correo; if(uData.etiqueta) document.getElementById('groupTag').innerText = uData.etiqueta; }
            const { data: evals } = await sbClient.from('evaluaciones').select('*').eq('usuario', user).order('created_at', {ascending:true});
            myEvals = evals || [];
            let sum = myEvals.reduce((a,b)=>a+b.nota,0); let avg = myEvals.length ? (sum/myEvals.length).toFixed(1) : 0; document.getElementById('stAvg').innerText = avg;
            const { data: assign } = await sbClient.from('asignaciones').select('cursos_json').eq('usuario', user).maybeSingle();
            if(assign) {
                const titles = JSON.parse(assign.cursos_json); document.getElementById('stTotal').innerText = titles.length;
                const { data: courses } = await sbClient.from('cursos').select('*').in('titulo', titles);
                groupedModules = {}; courses.forEach(c => { if(c.tipo === 'simulador') return; let m = c.modulo || 'General'; if(!groupedModules[m]) groupedModules[m] = []; groupedModules[m].push(c); });
                renderModules(); availableSims = courses.filter(c => c.tipo === 'simulador'); renderSims();
            }
            loadRanking(); loadDuels();
        }

        function renderModules() {
            let h = ''; for(let m in groupedModules) { let total = groupedModules[m].length, done = 0; groupedModules[m].forEach(c => { if(myEvals.find(e => e.curso === c.titulo)) done++; }); let pct = total ? Math.round((done/total)*100) : 0; h += `<div class="module-card" onclick="openDetail('${m}')"><div style="display:flex;align-items:center;gap:15px;margin-bottom:20px"><div style="width:50px;height:50px;background:#eef2ff;color:#4f46e5;border-radius:14px;display:flex;justify-content:center;align-items:center;font-size:1.5rem"><i class="fas fa-folder-open"></i></div><h3 style="margin:0;font-size:1.1rem">${m}</h3></div><div class="progress-container"><div class="progress-bar" style="width:${pct}%"></div></div></div>`; } document.getElementById('modulesGrid').innerHTML = h;
        }
        function openDetail(m) { document.getElementById('modulesGrid').style.display='none'; document.getElementById('detailView').style.display='block'; document.getElementById('modTitleName').innerText = m; let h = ''; groupedModules[m].forEach(c => { let evs = myEvals.filter(e => e.curso === c.titulo); let last = evs.length ? evs[evs.length-1] : null; let btn = `<button class="btn-action" onclick="launch('${c.id}','${c.tipo}','${c.video}','${c.titulo}')">Iniciar</button>`; if(c.tipo === 'examen' && last) { btn = last.retest_active ? `<button class="btn-action" style="background:#f59e0b" onclick="launch('${c.id}','${c.tipo}','${c.video}','${c.titulo}', true)">Reintentar</button>` : `<button class="btn-action" style="background:#10b981;cursor:default">Nota: ${last.nota}</button>`; } let icon = c.tipo==='examen' ? '<i class="fas fa-file-signature"></i>' : '<i class="fas fa-play-circle"></i>'; h += `<div class="course-item"><div style="font-size:1.5rem;color:#4f46e5">${icon}</div><div style="flex:1"><h4 style="margin:0">${c.titulo}</h4></div>${btn}</div>`; }); document.getElementById('coursesGrid').innerHTML = h; }
        function closeDetail() { document.getElementById('detailView').style.display='none'; document.getElementById('modulesGrid').style.display='grid'; }

        function launch(id, type, url, title, isRetest=false) {
            currentCourse = title; document.getElementById('mTitle').innerText = title;
            let area = document.getElementById('mBody'); document.getElementById('appModal').style.display='flex';
            const footer = document.getElementById('mFooter'); const btn = document.getElementById('btnAction');
            area.className = 'modal-body'; footer.style.display='none'; area.innerHTML='';
            let evs = myEvals.filter(e => e.curso === title); let last = evs.length ? evs[evs.length-1] : null;
            if (type === 'examen') { if (last && !last.retest_active && !isRetest) { area.className='modal-body'; area.innerHTML = `<div style="text-align:center;margin-top:50px"><h2>Completado</h2></div>`; return; } area.innerHTML = `<div style="text-align:center;margin-top:50px"><h2>Evaluaci√≥n Te√≥rica</h2><p>10 min.</p></div>`; footer.style.display='block'; btn.innerText='Comenzar'; btn.onclick=renderExam; } 
            else if (type === 'video') { let vidId = url.split('v=')[1]||url.split('/').pop(); area.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${vidId}" frameborder="0" allowfullscreen></iframe>`; if(!last || last.retest_active || isRetest) { footer.style.display='block'; btn.innerText='Esperando...'; btn.disabled=true; setTimeout(()=>{ btn.disabled=false; btn.innerText='Ir a Evaluaci√≥n'; btn.onclick=renderExam; }, 5000); } } 
            else if (type === 'pdf') { area.innerHTML = `<iframe width="100%" height="100%" src="${url}"></iframe>`; }
        }

        async function renderExam() { const body = document.getElementById('mBody'); document.getElementById('mFooter').style.display='none'; const { data: qs } = await sbClient.from('preguntas').select('*').eq('curso', currentCourse); if(!qs || !qs.length) { body.innerHTML='<h3>Sin preguntas.</h3>'; return; } let h = `<div style="max-width:800px; margin:0 auto">`; qs.forEach((q,i) => { h+=`<div style="background:white;padding:20px;border-radius:16px;margin-bottom:15px;border:1px solid #f1f5f9"><h4>${i+1}. ${q.pregunta}</h4><label style="display:block;margin:5px 0"><input type="radio" name="q${q.id}" value="op1"> ${q.opcion1}</label><label style="display:block;margin:5px 0"><input type="radio" name="q${q.id}" value="op2"> ${q.opcion2}</label><label style="display:block;margin:5px 0"><input type="radio" name="q${q.id}" value="op3"> ${q.opcion3}</label></div>`; }); h+=`<button class="btn-action" style="width:100%;margin-top:20px" onclick="submitExam()">Enviar</button></div>`; body.innerHTML = h; }
        async function submitExam() { const { data: qs } = await sbClient.from('preguntas').select('*').eq('curso', currentCourse); let score = 0, total = 0, det = []; qs.forEach(q => { total += 2; const sel = document.querySelector(`input[name="q${q.id}"]:checked`); let st = "INCORRECTO", val = "Sin respuesta"; if(sel) { val = sel.parentElement.innerText; if(sel.value === q.correcta) { score+=2; st="CORRECTO"; } } det.push(`[P: ${q.pregunta} | R: ${val} (${st})]`); }); let final = Math.round((score/total)*20); const currentGroup = document.getElementById('groupTag').innerText; await sbClient.from('evaluaciones').insert([{ usuario: user, curso: currentCourse, nota: final, grupo: currentGroup, detalle: det.join(" ||| "), retest_active: false }]); await sbClient.from('evaluaciones').update({retest_active:false}).eq('usuario',user).eq('curso',currentCourse).eq('retest_active',true); const {data:evs} = await sbClient.from('evaluaciones').select('nota').eq('usuario',user); let sum=evs.reduce((a,b)=>a+b.nota,0); await sbClient.from('usuarios').update({promedio:(sum/evs.length).toFixed(1)}).eq('usuario',user); alert('Nota: '+final); closeModal(); loadData(); }

        // --- RESULTADOS CON FEEDBACK INTELIGENTE ---
        async function loadResults() {
            const { data: evs } = await sbClient.from('evaluaciones').select('*').eq('usuario', user).order('created_at', {ascending:false});
            const { data: iaData } = await sbClient.from('sesiones_roleplay').select('*').eq('usuario', user).order('created_at', {ascending: false});
            let h = '';
            
            if(evs) evs.forEach(e => {
                let cls = e.nota >= 14 ? 'pass' : 'fail';
                h += `<div class="res-card ${cls}"><div class="res-info"><h4>${e.curso}</h4><div class="res-meta"><span>${new Date(e.created_at).toLocaleDateString()}</span></div><button class="res-btn" onclick="alert('Examen Te√≥rico: ${e.nota}')">Ver Nota</button></div><div class="res-score"><h2>${e.nota}</h2><small>NOTA</small></div></div>`;
            });

            if(iaData) iaData.forEach(e => {
                let cls = e.puntaje_total >= 70 ? 'pass' : 'fail';
                const detailStr = encodeURIComponent(JSON.stringify(e.detalle_json || {}));
                h += `<div class="res-card ${cls}"><div class="res-info"><h4>Roleplay: ${e.escenario}</h4><div class="res-meta"><span><i class="fas fa-robot"></i> ${new Date(e.created_at).toLocaleDateString()}</span></div><button class="res-btn" onclick="viewDetailedFeedback('${detailStr}')">Ver An√°lisis IA</button></div><div class="res-score"><h2>${e.puntaje_total}%</h2><small>PUNTOS</small></div></div>`;
            });
            document.getElementById('resList').innerHTML = h || '<p>Sin resultados a√∫n.</p>';
        }

        // --- FUNCI√ìN DE VISUALIZACI√ìN DE FEEDBACK ---
        function viewDetailedFeedback(encodedJson) {
            const data = JSON.parse(decodeURIComponent(encodedJson));
            document.getElementById('mTitle').innerText = 'Feedback de Desempe√±o';
            let html = '';

            // 1. Resumen Cualitativo
            html += `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:25px;">`;
            html += `<div style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius:12px; padding:20px;"><h4 style="margin:0 0 10px 0; color:#166534; display:flex; align-items:center; gap:8px;"><i class="fas fa-thumbs-up"></i> Lo hiciste bien</h4><ul style="margin:0; padding-left:20px; color:#14532d; font-size:0.9rem;">`;
            if(data.fortalezas && data.fortalezas.length > 0) data.fortalezas.forEach(f => html += `<li style="margin-bottom:5px;">${f}</li>`); else html += `<li>Buen intento general.</li>`;
            html += `</ul></div>`;
            html += `<div style="background:#fef2f2; border:1px solid #fecaca; border-radius:12px; padding:20px;"><h4 style="margin:0 0 10px 0; color:#991b1b; display:flex; align-items:center; gap:8px;"><i class="fas fa-exclamation-circle"></i> Puntos a Mejorar</h4><ul style="margin:0; padding-left:20px; color:#7f1d1d; font-size:0.9rem;">`;
            if(data.areas_mejora && data.areas_mejora.length > 0) data.areas_mejora.forEach(m => html += `<li style="margin-bottom:5px;">${m}</li>`); else html += `<li>Seguir practicando.</li>`;
            html += `</ul></div></div>`;

            // 2. An√°lisis T√©cnico
            if(data.mejoras && data.mejoras.length > 0) {
                html += `<h4 style="color:#475569; margin-bottom:15px; border-top:1px solid #e2e8f0; padding-top:20px;">üîç Correcci√≥n T√©cnica (Ejemplos)</h4>`;
                data.mejoras.forEach(m => {
                    html += `<div class="imp-card"><div class="imp-header"><i class="fas fa-graduation-cap" style="color:var(--primary)"></i> <span class="imp-title" style="color:#334155">${m.criterio}</span></div><div class="imp-grid"><div class="imp-col-bad"><span class="imp-label" style="color:#b91c1c">‚ùå Dijiste (o falt√≥):</span><p class="imp-text">"${m.error_cita}"</p></div><div class="imp-col-good"><span class="imp-label" style="color:#047857">‚úÖ T√©cnica Recomendada:</span><span class="imp-badge">${m.tecnica_sugerida}</span><p class="imp-text">"${m.ejemplo_script}"</p></div></div></div>`;
                });
            } else if (data.feedback) {
                html += `<div class="feedback-box"><h4><i class="fas fa-robot"></i> Resumen del Coach</h4><p>${data.feedback}</p></div>`;
            }

            document.getElementById('mBody').innerHTML = html;
            document.getElementById('appModal').style.display = 'flex';
            document.getElementById('mFooter').style.display = 'none';
        }

        async function loadCerts() { const { data } = await sbClient.from('usuarios').select('certificados_json').eq('usuario', user).single(); let certs = data.certificados_json ? JSON.parse(data.certificados_json) : []; let h = ''; if(certs.length === 0) h = '<p style="text-align:center;color:#999">A√∫n no tienes certificados.</p>'; certs.forEach(t => { h += `<div class="cert-card" onclick="genPDF('${t}')"><div class="cert-icon"><i class="fas fa-award"></i></div><h4>${t}</h4><button class="res-btn">Descargar</button></div>`; }); document.getElementById('certList').innerHTML = h; }
        async function genPDF(title) { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' }); const img = new Image(); img.src = 'certificado_bg.png'; img.onload = function() { doc.addImage(img, 'PNG', 0, 0, 297, 210); doc.setFontSize(22); doc.text(title, 148, 95, {align:"center"}); doc.setFontSize(40); doc.text(userCertName, 148, 135, {align:"center"}); doc.save(`Certificado.pdf`); }; img.onerror=()=>{alert("Falta imagen");} }
        async function loadRanking(){ const groupTag = document.getElementById('groupTag').innerText; const {data}=await sbClient.from('usuarios').select('usuario,promedio').eq('etiqueta',groupTag).order('promedio',{ascending:false}).limit(10); let h=''; data.forEach((u,i)=>{ h+=`<div class="rank-row"><div class="rank-pos">${i+1}</div><div style="flex:1;font-weight:700">${u.usuario}</div><div class="rank-pts">${u.promedio||0}</div></div>`; }); document.getElementById('rankList').innerHTML=h; }
        async function loadIARoleplays() { const { data } = await sbClient.from('roleplay_scenarios').select('*'); let h = ''; data.forEach(r => { h += `<div class="rp-card"><div><h4 style="margin:0">${r.titulo}</h4><small>IA Training</small></div><a href="iacliente.html?id=${r.id}" class="btn-start-rp"><i class="fas fa-microphone"></i> Practicar</a></div>`; }); document.getElementById('rpList').innerHTML = h; }
        function renderSims() { let h = ''; availableSims.forEach((s, i) => { h += `<div class="course-item"><h4>${s.titulo}</h4><button class="btn-action" onclick="initSim(${i})">Jugar</button></div>`; }); document.getElementById('simList').innerHTML = h; }
        function initSim(i) { try { simData = JSON.parse(availableSims[i].data_juego); simStep=0; document.getElementById('appModal').style.display='flex'; runSimStep(); } catch(e){ alert("Error datos sim"); } }
        function runSimStep() { let s = simData[simStep]; if(!s) { alert("Fin"); closeModal(); return; } document.getElementById('mBody').innerHTML = `<div style="background:#f1f5f9;padding:15px;border-radius:15px;margin-bottom:20px">${s.cliente}</div><div id="simOpts"></div>`; let h=''; s.opciones.forEach((o, i) => { h += `<div style="padding:10px;border:1px solid #ddd;margin-bottom:5px;cursor:pointer" onclick="checkSim(${i})">${o}</div>`; }); document.getElementById('simOpts').innerHTML = h; }
        function checkSim(i) { if(i==simData[simStep].correcta) { simStep++; runSimStep(); } else alert("Incorrecto"); }
        async function loadDuels(){ const {data}=await sbClient.from('duelos').select('*').order('created_at',{ascending:false}); let h=''; data.forEach(d=>h+=`<div style="padding:15px;background:white;margin-bottom:10px;border-radius:10px"><b>${d.retador} vs ${d.oponente}</b><br><small>${d.estado}</small></div>`); document.getElementById('duelsList').innerHTML=h; }
        async function createDuel(){ let op=prompt("Oponente:"); if(op) await sbClient.from('duelos').insert([{retador:user, oponente:op, estado:'PENDIENTE'}]); loadDuels(); }
        function initChat(){ sbClient.channel('chat').on('postgres_changes',{event:'INSERT',schema:'public',table:'chat'},p=>{ if(p.new.destinatario===user){ chatMsgs.push(p.new); renderChat(); } }).subscribe(); checkMsg(); }
        async function checkMsg(){ const {data}=await sbClient.from('chat').select('*').or(`and(remitente.eq.Admin,destinatario.eq.${user}),and(remitente.eq.${user},destinatario.eq.Admin)`).order('created_at',{ascending:true}); chatMsgs=data; renderChat(); }
        function renderChat(){ const b=document.getElementById('chatBox'); b.innerHTML=''; chatMsgs.forEach(m=>{ let cls=m.remitente===user?'me':'other'; b.innerHTML+=`<div class="msg ${cls}" style="margin-bottom:5px">${m.mensaje}</div>`; }); b.scrollTop=b.scrollHeight; }
        async function sendMsg(){ const t=document.getElementById('msgInput').value; if(!t)return; await sbClient.from('chat').insert([{remitente:user, destinatario:'Admin', mensaje:t, leido:false}]); document.getElementById('msgInput').value=''; checkMsg(); }
    </script>
</body>
</html>