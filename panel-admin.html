<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geincos Admin | Gestión Profesional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #4f46e5; --bg-body: #f3f4f6; --surface: #ffffff; --text-main: #1e293b; --text-muted: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --border: #e2e8f0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: var(--surface); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .brand i { font-size: 1.5rem; color: var(--primary); } .brand span { font-size: 1.25rem; font-weight: 800; }
        .menu-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin: 20px 0 10px 10px; }
        .menu-item { padding: 12px 16px; color: var(--text-muted); border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; text-decoration: none; position: relative; }
        .menu-item:hover { background: #eef2ff; color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; }
        .menu-badge { position: absolute; right: 15px; background: #ef4444; color: white; font-size: 0.7rem; font-weight: bold; padding: 2px 8px; border-radius: 10px; display: none; }

        .main-content { flex: 1; padding: 32px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: center; } h2 { font-size: 1.8rem; font-weight: 700; }
        .content-section { display: none; flex-direction: column; height: 100%; } .content-section.active { display: flex; }

        .table-container { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; max-height: 80vh; }
        .table-scroll { overflow-y: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8fafc; text-align: left; padding: 16px 24px; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); position: sticky; top: 0; z-index: 10; text-transform: uppercase; }
        td { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; word-wrap: break-word; }
        tr:hover { background: #f8fafc; }

        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-secondary { background: #e2e8f0; color: var(--text-main); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; color: white; }
        .btn-edit { background: var(--warning); } .btn-delete { background: var(--danger); } .btn-assign { background: var(--success); }
        .btn-eval { background: #8b5cf6; } 
        
        .btn-retest { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .btn-certify { background: var(--warning); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .btn-add-opt { width: 100%; padding: 8px; background: #eef2ff; color: var(--primary); border: 1px dashed var(--primary); border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: 600; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 650px; max-width: 95%; padding: 30px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.2s; }
        textarea.form-control { resize: vertical; min-height: 80px; }
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }

        .key-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .key-row input { flex: 1; font-family: monospace; font-size: 0.85rem; }
        .btn-remove-key { background: #fee2e2; color: #ef4444; border: none; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .assign-container { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; background: #f8fafc; }
        .assign-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .assign-item:hover { border-color: var(--primary); background: #eef2ff; }
        .assign-item input { width: 18px; height: 18px; accent-color: var(--primary); }
        .assign-tag { margin-left: auto; font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
        .tag-course { background: #e0e7ff; color: var(--primary); }
        .tag-sim { background: #fce7f3; color: #db2777; }
        .tag-ia { background: #dcfce7; color: #166534; }

        .btn-toggle-row { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; transition: transform 0.2s; display: block; margin: 0 auto; }
        .btn-toggle-row.rotated { transform: rotate(180deg); color: var(--primary); }
        .exam-detail-row { display: none; background: #f8fafc; }
        .exam-detail-content { padding: 20px; display: flex; flex-direction: column; gap: 15px; max-height: 250px; overflow-y: auto; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; }
        .exam-opt { background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: flex-start; gap: 10px; }
        .exam-opt strong { color: var(--primary); font-size: 0.75rem; text-transform: uppercase; min-width: 70px; margin-top: 3px; }

        .calidad-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .calidad-card { background: white; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .calidad-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .calidad-card::before { content:''; position: absolute; left:0; top:0; height:100%; width:5px; background: #cbd5e1; }
        .calidad-card.pass::before { background: var(--success); }
        .calidad-card.fail::before { background: var(--danger); }
        .c-user { font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 5px; }
        .c-date { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; display: block; }
        .c-score { font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .c-tag { position: absolute; top: 20px; right: 20px; background: #f1f5f9; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; }

        .q-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 20px; }
        .q-score-big { font-size: 3.5rem; font-weight: 800; line-height: 1; margin-top: 5px; }
        .q-grid-items { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .q-item { background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: 0.2s; }
        .q-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .q-item.ok { border-left: 5px solid var(--success); }
        .q-item.bad { border-left: 5px solid var(--danger); }
        .q-feedback-box { margin-top: 25px; background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 20px; border-radius: 12px; line-height: 1.6; font-size: 0.95rem; display: flex; gap: 15px; }
        .q-feedback-icon { font-size: 1.5rem; color: #d97706; }

        .chat-layout { display: flex; height: 75vh; background: #fff; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #f1f5f9; }
        .chat-sidebar { width: 320px; border-right: 1px solid #f1f5f9; display: flex; flex-direction: column; }
        .chat-user-list { flex: 1; overflow-y: auto; }
        .chat-user-item { padding: 15px 20px; display: flex; gap: 15px; cursor: pointer; border-bottom: 1px solid #f8fafc; align-items: center; }
        .chat-user-item:hover, .chat-user-item.active { background: #eef2ff; }
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #f8fafc; }
        .chat-messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg-row { display: flex; width: 100%; margin-bottom: 5px; } .msg-row.me { justify-content: flex-end; }
        .msg-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; background: white; border: 1px solid #e2e8f0; }
        .msg-row.me .msg-bubble { background: var(--primary); color: white; border: none; }
        
        .sim-editor { background: white; padding: 25px; border-radius: 16px; height: 100%; display: flex; flex-direction: column; gap: 20px; }
        .step-card { border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; margin-bottom: 15px; background: #f8fafc; position: relative; }
        .step-card h4 { margin: 0 0 15px 0; color: var(--primary); font-size: 1rem; }
        .step-card .delete-step { position: absolute; top: 15px; right: 15px; color: var(--danger); cursor: pointer; font-size: 1.1rem; }
        
        /* DETALLE ROW */
        .detail-row { display: none; background-color: #fefce8; } 
        .detail-row.show { display: table-row; }
        .detail-content { padding: 20px 30px; font-size: 0.9rem; color: #475569; line-height: 1.6; }
        .incorrect-item { color: #b91c1c; margin-bottom: 5px; display: flex; align-items: flex-start; gap: 8px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand"><i class="fas fa-cube"></i><span>Geincos Admin</span></div>
        <div class="menu-label">Analítica</div>
        <a href="dashboard.html" class="menu-item"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <div class="menu-item" onclick="nav('reports', this)"><i class="fas fa-file-invoice"></i> Reportes</div>
        <div class="menu-item" onclick="nav('calidad', this); loadCalidadData()"><i class="fas fa-check-circle"></i> Calidad IA</div>
        <div class="menu-item" onclick="nav('duels', this)"><i class="fas fa-trophy"></i> Resultados PvP</div>
        <div class="menu-item" onclick="nav('chat', this)"><i class="fas fa-comments"></i> Mensajería <span class="menu-badge" id="chatBadge">0</span></div>
        <div class="menu-label">Gestión</div>
        <div class="menu-item active" onclick="nav('users', this)"><i class="fas fa-users"></i> Usuarios</div>
        <div class="menu-item" onclick="nav('courses', this)"><i class="fas fa-book"></i> Materiales</div>
        <div class="menu-item" onclick="nav('exams', this)"><i class="fas fa-clipboard-check"></i> Exámenes</div>
        <div class="menu-item" onclick="nav('sims', this)"><i class="fas fa-gamepad"></i> Simuladores</div>
        <div class="menu-item" onclick="nav('iaroleplay', this)"><i class="fas fa-robot"></i> IA Roleplay</div>
        <div class="menu-item" style="margin-top:auto; color:var(--danger)" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</div>
    </div>

    <div class="main-content">
        <div id="calidad" class="content-section">
            <div class="header">
                <h2>Evaluaciones IA</h2>
                <button class="btn-primary" onclick="openConfigCalidad()">⚙️ Configurar Criterios</button>
            </div>
            <div id="calidadGrid" class="calidad-grid">Cargando...</div>
        </div>

        <div id="iaroleplay" class="content-section">
            <div class="header"><h2>IA Roleplay (Escenarios)</h2><button class="btn-primary" onclick="openModal('modalRoleplay', 'create')">+ Nuevo Escenario</button></div>
            <div class="table-container"><div class="table-scroll"><table><thead><tr><th>Título</th><th>Cliente</th><th>Deuda</th><th>Keys</th><th>Acciones</th></tr></thead><tbody id="tbRoleplays"></tbody></table></div></div>
        </div>

        <div id="reports" class="content-section">
            <div class="header"><h2>Reportes y Certificación</h2><button class="btn-secondary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Descargar Excel</button></div>
            <div class="table-container"><div class="table-scroll"><table id="reportsTable"><thead><tr><th>Fecha</th><th>Usuario</th><th>Curso</th><th>Módulo</th><th>Nota</th><th>Acciones</th></tr></thead><tbody id="tbReports"></tbody></table></div></div>
        </div>

        <div id="users" class="content-section active">
            <div class="header">
                <h2>Usuarios</h2>
                <div style="display:flex; gap:10px">
                    <button class="btn-secondary" onclick="exportUsersToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn-primary" onclick="openModal('modalUser', 'create')">+ Nuevo</button>
                </div>
            </div>
            <div class="table-container"><div class="table-scroll"><table><thead><tr><th>Usuario</th><th>DNI</th><th>Grupo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tbUsers"></tbody></table></div></div>
        </div>

        <div id="courses" class="content-section">
            <div class="header"><h2>Materiales</h2><button class="btn-primary" onclick="openModal('modalCourse', 'create')">+ Nuevo</button></div>
            <div class="table-container"><div class="table-scroll"><table><thead><tr><th>Módulo</th><th>Título</th><th>Tipo</th><th>Acciones</th></tr></thead><tbody id="tbCourses"></tbody></table></div></div>
        </div>

        <div id="sims" class="content-section">
            <div class="header"><h2>Simuladores Clásicos</h2><button class="btn-primary" onclick="openSimEditor('create')">+ Nuevo</button></div>
            <div class="table-container"><div class="table-scroll"><table><thead><tr><th>Título</th><th>Descripción</th><th>Acciones</th></tr></thead><tbody id="tbSims"></tbody></table></div></div>
        </div>

        <div id="sims-editor" class="content-section">
            <div class="header"><h2>Editor de Escenarios</h2><div style="display:flex;gap:10px"><button class="btn-secondary" onclick="closeSimEditor()">Cancelar</button><button class="btn-primary" onclick="saveSim()">Guardar</button></div></div>
            <div class="sim-editor">
                <div style="display:flex; gap:15px;"><input id="simTitle" class="form-control" placeholder="Título"><input id="simDesc" class="form-control" placeholder="Descripción"></div>
                <div id="stepsContainer" style="flex:1; overflow-y:auto; border-top:1px solid #eee; padding-top:10px"></div>
                <button class="btn-primary" style="align-self:center" onclick="addStep()">+ Agregar Paso</button>
            </div>
        </div>

        <div id="exams" class="content-section">
            <div class="header"><h2>Exámenes</h2><button class="btn-primary" onclick="openModal('modalQuestion','create')">+ Pregunta</button></div>
            <div class="table-container" style="padding:20px">
                <select id="selCourseEx" class="form-control" onchange="loadQuestions()" style="margin-bottom:15px"></select>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px"></th>
                            <th style="width: 60%">Pregunta</th>
                            <th style="width: 20%">Respuesta Correcta</th>
                            <th style="width: 15%">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbQuestions"></tbody>
                </table>
            </div>
        </div>
        
        <div id="chat" class="content-section"><div class="header"><h2>Mensajería</h2></div><div class="chat-layout"><div class="chat-sidebar" id="chatUserList"></div><div class="chat-main"><div class="chat-messages" id="chatMessages"></div><div style="padding:15px;background:white;display:flex;gap:10px"><input id="chatInput" class="form-control"><button class="btn-primary" onclick="sendMessage()">Enviar</button></div></div></div></div>
        <div id="duels" class="content-section"><div class="header"><h2>PvP</h2></div><div class="table-container"><table><tbody id="tbDuels"></tbody></table></div></div>
    </div>

    <div class="modal-overlay" id="modalEval">
        <div class="modal-box">
            <h3>Evaluación Final</h3>
            <input type="hidden" id="evalUserId">
            <div class="form-group">
                <label>Resultado</label>
                <select id="evalStatus" class="form-control" onchange="toggleEvalFields()">
                    <option value="">Seleccionar...</option>
                    <option value="Aprueba">Aprueba</option>
                    <option value="No Pasa">No Pasa</option>
                </select>
            </div>
            <div class="form-group">
                <label>Observación General</label>
                <textarea id="evalObs" class="form-control" placeholder="Comentarios sobre el desempeño..."></textarea>
            </div>
            <div id="evalPassFields" style="display:none; padding:15px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:10px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px 0; color:#166534">Datos de Ingreso</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <div class="form-group"><label>Cartera</label><input id="evalCartera" class="form-control"></div>
                    <div class="form-group"><label>Supervisor</label><input id="evalSupervisor" class="form-control"></div>
                </div>
                <div class="form-group" style="margin-top:10px">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; color:#15803d; font-weight:700">
                        <input type="checkbox" id="evalCert" style="width:20px; height:20px; accent-color:var(--success)">
                        Generar Certificado de Finalización
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModals()">Cancelar</button>
                <button class="btn-primary" onclick="saveEvaluation()">Guardar Evaluación</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalConfigCalidad"><div class="modal-box" style="width:700px"><h3>Configuración de Criterios de Calidad</h3><p style="color:#64748b; font-size:0.9rem; margin-bottom:15px">Estos criterios se aplicarán a todas las evaluaciones automáticas.</p><div style="background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px"><div style="display:grid; grid-template-columns: 2fr 1fr 40px; gap:10px; font-weight:700; color:#4f46e5; margin-bottom:5px; padding:0 10px"><span>Criterio</span><span>Puntos</span><span></span></div><div id="criteriaList" style="max-height:400px; overflow-y:auto; display:flex; flex-direction:column; gap:8px"></div></div><button class="btn-add-opt" onclick="addCriteriaRow()">+ Agregar Criterio</button><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveConfigCalidad()">Guardar Cambios</button></div></div></div>
    <div class="modal-overlay" id="modalCalidad"><div class="modal-box" style="width:700px; background:#f8fafc"><div id="calidadDetalle"></div><div class="modal-actions" style="border-top:1px solid #e2e8f0; padding-top:15px"><button class="btn-secondary" onclick="closeModals()">Cerrar</button></div></div></div>
    <div class="modal-overlay" id="modalRoleplay"><div class="modal-box"><h3>Configurar Escenario IA</h3><input type="hidden" id="rpId"><div class="form-group"><label>Título</label><input id="rpTitulo" class="form-control"></div><div class="form-group"><label>Prompt</label><textarea id="rpPrompt" class="form-control"></textarea></div><div style="background:#f8fafc;padding:15px;border-radius:10px;margin-bottom:15px;border:1px solid #eee"><h4 style="margin-bottom:10px">Datos Cliente</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><input id="rpCliNombre" class="form-control" placeholder="Nombre"><input id="rpCliProd" class="form-control" placeholder="Producto"><input id="rpCliDeuda" class="form-control" placeholder="Deuda"><input id="rpCliMora" class="form-control" placeholder="Mora"><input id="rpCliCapital" class="form-control" placeholder="Capital"><input id="rpCliCampana" class="form-control" placeholder="Campaña"></div></div><div class="form-group"><label>API Keys (Rotativas)</label><div id="apiKeysContainer" style="max-height:100px;overflow-y:auto;margin-bottom:10px"></div><button class="btn-add-opt" onclick="addApiKeyField()">+ Agregar Key</button></div><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveRoleplay()">Guardar</button></div></div></div>
    <div class="modal-overlay" id="modalAssign"><div class="modal-box"><h3>Asignar a <span id="assignTarget" style="color:var(--primary)"></span></h3><div id="assignList" class="assign-container"></div><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cerrar</button><button class="btn-primary" onclick="saveAssignments()">Guardar</button></div></div></div>
    <div class="modal-overlay" id="modalUser"><div class="modal-box"><h3>Usuario</h3><input type="hidden" id="uId"><input id="uUser" class="form-control" placeholder="Usuario"><input id="uDni" class="form-control" placeholder="DNI"><input id="uPass" class="form-control" placeholder="Pass"><input id="uTag" class="form-control" placeholder="Grupo"><input id="uEmail" class="form-control" placeholder="Correo (Nombre Completo)"><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveUser()">Guardar</button></div></div></div>
    <div class="modal-overlay" id="modalCourse"><div class="modal-box"><h3>Material</h3><input type="hidden" id="cId"><input id="cMod" class="form-control" placeholder="Módulo"><input id="cTitle" class="form-control" placeholder="Título"><select id="cType" class="form-control"><option value="video">Video</option><option value="pdf">PDF</option><option value="examen">Examen</option></select><input id="cUrl" class="form-control" placeholder="URL"><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveCourse()">Guardar</button></div></div></div>
    <div class="modal-overlay" id="modalQuestion"><div class="modal-box"><h3>Pregunta</h3><input type="hidden" id="qId"><input id="qTxt" class="form-control" placeholder="Pregunta"><input id="op1" class="form-control" placeholder="Op1"><input id="op2" class="form-control" placeholder="Op2"><input id="op3" class="form-control" placeholder="Op3"><select id="qCorrect" class="form-control"><option value="op1">Op1</option><option value="op2">Op2</option><option value="op3">Op3</option></select><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveQuestion()">Guardar</button></div></div></div>

    <script>
        const SB_URL = 'https://xgvfcmadsprjyljtpooo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndmZjbWFkc3ByanlsanRwb29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODMxNjAsImV4cCI6MjA4MjE1OTE2MH0.XYBbKFE17PfyYMn2SNL5UJrCQmDRbimTQO0jpbX1Zd0';
        const sbClient = supabase.createClient(SB_URL, SB_KEY);
        let currentAssignUser='', editorSteps=[], currentSimId=null, currentChatUser='';
        let reportDataForExcel = [];
        let usersDataForExcel = [];

        window.onload = () => { loadUsers(); loadCourses(); loadSims(); loadReports(); loadDuels(); loadExamCourses(); loadRoleplays(); };
        function nav(id, el) { document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); el.classList.add('active'); if(id==='chat') loadChatUsers(); }
        function closeModals(){ document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); }
        function openModal(id, mode){ document.getElementById(id).style.display='flex'; if(mode==='create'){ if(id==='modalRoleplay') clearRoleplayForm(); if(id==='modalCourse') clearCourseForm(); if(id==='modalQuestion') clearQuestionForm(); } }
        function logout(){ localStorage.clear(); window.location.href='index.html'; }

        // --- GESTIÓN USUARIOS (CON EVALUAR) ---
        async function loadUsers(){ 
            const {data}=await sbClient.from('usuarios').select('*').neq('rol','admin').order('id'); 
            usersDataForExcel = data.map(u => ({ "ID": u.id, "Usuario": u.usuario, "Nombre Completo": u.correo || '', "DNI": u.dni, "Grupo": u.etiqueta, "Estado": u.estado_capacitacion||'En curso', "Cartera": u.cartera||'', "Supervisor": u.supervisor||'', "Observación": u.observacion||'' }));

            let h=''; 
            data.forEach(u=>{ 
                let stStyle = u.estado_capacitacion === 'Aprobado' ? 'background:#dcfce7;color:#166534' : (u.estado_capacitacion === 'Desaprobado' ? 'background:#fee2e2;color:#991b1b' : 'background:#f1f5f9;color:#64748b');
                let stText = u.estado_capacitacion || 'En Curso';

                h+=`<tr>
                    <td><b>${u.usuario}</b><br><small style="color:#64748b">${u.correo || ''}</small></td>
                    <td>${u.dni}</td>
                    <td>${u.etiqueta}</td>
                    <td><span style="padding:4px 8px; border-radius:12px; font-size:0.75rem; font-weight:700; ${stStyle}">${stText}</span></td>
                    <td>
                        <button class="btn-icon btn-assign" title="Asignar Cursos" onclick="assign('${u.usuario}')"><i class="fas fa-book"></i></button>
                        <button class="btn-icon btn-edit" title="Editar" onclick="editUser('${u.id}','${u.usuario}','${u.dni}','${u.etiqueta}','${u.correo||''}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon btn-delete" title="Eliminar" onclick="del('usuarios','${u.id}')"><i class="fas fa-trash"></i></button>
                        <button class="btn-icon btn-eval" title="Evaluar/Finalizar" onclick="openEvalModal('${u.id}')"><i class="fas fa-graduation-cap"></i></button>
                    </td>
                </tr>`; 
            }); 
            document.getElementById('tbUsers').innerHTML=h; 
        }

        // --- LÓGICA DE EVALUACIÓN FINAL ---
        let currentEvalUserId = '';
        async function openEvalModal(uid) {
            currentEvalUserId = uid;
            document.getElementById('evalStatus').value = '';
            document.getElementById('evalObs').value = '';
            document.getElementById('evalCartera').value = '';
            document.getElementById('evalSupervisor').value = '';
            document.getElementById('evalCert').checked = false;
            toggleEvalFields();
            
            const { data } = await sbClient.from('usuarios').select('*').eq('id', uid).single();
            if(data) {
                if(data.estado_capacitacion === 'Aprobado') document.getElementById('evalStatus').value = 'Aprueba';
                else if(data.estado_capacitacion === 'Desaprobado') document.getElementById('evalStatus').value = 'No Pasa';
                
                document.getElementById('evalObs').value = data.observacion || '';
                document.getElementById('evalCartera').value = data.cartera || '';
                document.getElementById('evalSupervisor').value = data.supervisor || '';
                toggleEvalFields();
            }
            openModal('modalEval');
        }

        function toggleEvalFields() {
            const val = document.getElementById('evalStatus').value;
            const extra = document.getElementById('evalPassFields');
            extra.style.display = (val === 'Aprueba') ? 'block' : 'none';
        }

        async function saveEvaluation() {
            const status = document.getElementById('evalStatus').value;
            const obs = document.getElementById('evalObs').value;
            if(!status) return alert("Selecciona un resultado (Aprueba/No Pasa).");

            let updates = { estado_capacitacion: status === 'Aprueba' ? 'Aprobado' : 'Desaprobado', observacion: obs };

            if (status === 'Aprueba') {
                updates.cartera = document.getElementById('evalCartera').value;
                updates.supervisor = document.getElementById('evalSupervisor').value;
                if (document.getElementById('evalCert').checked) {
                    const { data: u } = await sbClient.from('usuarios').select('certificados_json').eq('id', currentEvalUserId).single();
                    let certs = u.certificados_json ? JSON.parse(u.certificados_json) : [];
                    if (!certs.includes("CAPACITACION FINALIZADA")) {
                        certs.push("CAPACITACION FINALIZADA");
                        updates.certificados_json = JSON.stringify(certs);
                    }
                }
            } else { updates.cartera = null; updates.supervisor = null; }

            await sbClient.from('usuarios').update(updates).eq('id', currentEvalUserId);
            alert("Evaluación guardada correctamente."); closeModals(); loadUsers();
        }

        function exportUsersToExcel() {
            if(usersDataForExcel.length === 0) return alert("No hay usuarios para exportar");
            const ws = XLSX.utils.json_to_sheet(usersDataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Usuarios");
            XLSX.writeFile(wb, 'Usuarios_Geincos.xlsx');
        }

        // --- RESTO DE FUNCIONES (RESTORED) ---
        function editUser(id,u,d,t,e){ document.getElementById('uId').value=id; document.getElementById('uUser').value=u; document.getElementById('uDni').value=d; document.getElementById('uTag').value=t; document.getElementById('uEmail').value=e; openModal('modalUser'); }
        async function saveUser(){ const u={usuario:document.getElementById('uUser').value, dni:document.getElementById('uDni').value, etiqueta:document.getElementById('uTag').value, correo:document.getElementById('uEmail').value, rol:'asesor'}; const id=document.getElementById('uId').value; if(document.getElementById('uPass').value) u.password=document.getElementById('uPass').value; if(id) await sbClient.from('usuarios').update(u).eq('id',id); else await sbClient.from('usuarios').insert([u]); closeModals(); loadUsers(); }
        async function assign(u){ currentAssignUser=u; document.getElementById('assignTarget').innerText=u; openModal('modalAssign'); const {data:courses}=await sbClient.from('cursos').select('titulo, tipo'); const {data:scenarios}=await sbClient.from('roleplay_scenarios').select('titulo'); const {data:mine}=await sbClient.from('asignaciones').select('cursos_json').eq('usuario',u).maybeSingle(); let my=mine?JSON.parse(mine.cursos_json):[]; let h=''; courses.forEach(c=>{ let tag = c.tipo === 'simulador' ? '<span class="assign-tag tag-sim">Simulador</span>' : '<span class="assign-tag tag-course">Curso</span>'; h+=`<label class="assign-item"><input type="checkbox" class="chk" value="${c.titulo}" ${my.includes(c.titulo)?'checked':''}> <span>${c.titulo}</span> ${tag}</label>`; }); scenarios.forEach(s => { h+=`<label class="assign-item"><input type="checkbox" class="chk" value="${s.titulo}" ${my.includes(s.titulo)?'checked':''}> <span>${s.titulo}</span> <span class="assign-tag tag-ia">IA Roleplay</span></label>`; }); document.getElementById('assignList').innerHTML=h; }
        async function saveAssignments(){ const l=Array.from(document.querySelectorAll('.chk:checked')).map(c=>c.value); const {data:ex}=await sbClient.from('asignaciones').select('id').eq('usuario',currentAssignUser).maybeSingle(); if(ex) await sbClient.from('asignaciones').update({cursos_json:JSON.stringify(l)}).eq('id',ex.id); else await sbClient.from('asignaciones').insert([{usuario:currentAssignUser,cursos_json:JSON.stringify(l)}]); alert('Asignado'); closeModals(); }
        
        async function loadReports(){ 
            const {data: evals} = await sbClient.from('evaluaciones').select('*').order('created_at',{ascending:false});
            const {data: users} = await sbClient.from('usuarios').select('usuario, correo');
            const userMap = {}; if(users) users.forEach(u => userMap[u.usuario] = u.correo || '');
            reportDataForExcel = [];
            let h=''; 
            if(evals) evals.forEach(r=>{ 
                const btn = r.retest_active ? '<span style="color:var(--success);font-weight:700">Retest Activo</span>' : `<button class="btn-retest" onclick="retest('${r.id}')"><i class="fas fa-sync"></i> Retest</button>`;
                const nombreCompleto = userMap[r.usuario] || '-';
                reportDataForExcel.push({ "Fecha": new Date(r.created_at).toLocaleDateString(), "Usuario": r.usuario, "Nombre Completo": nombreCompleto, "Curso": r.curso, "Módulo": r.grupo || '-', "Nota": r.nota });
                const det = r.detalle ? formatDetails(r.detalle) : '<span style="color:#999">Sin detalle</span>';
                const rowId = `detail-${r.id}`;
                h+=`<tr><td><button class="btn-toggle-row" onclick="toggleDetail('${rowId}', this)"><i class="fas fa-chevron-down"></i></button></td><td>${new Date(r.created_at).toLocaleDateString()}</td><td><b>${r.usuario}</b><br><small style="color:#64748b">${nombreCompleto}</small></td><td>${r.curso}</td><td>${r.grupo||'-'}</td><td><span style="font-weight:800; color:${r.nota>=14?'var(--success)':'var(--danger)'}">${r.nota}</span></td><td style="display:flex; gap:10px;"><button class="btn-certify" onclick="cert('${r.usuario}','${r.curso}')"><i class="fas fa-certificate"></i> Certificar</button>${btn}</td></tr><tr id="${rowId}" class="detail-row"><td colspan="7"><div class="detail-content">${det}</div></td></tr>`; 
            }); 
            document.getElementById('tbReports').innerHTML=h; 
        }
        function toggleDetail(id, btn) { const row = document.getElementById(id); if (row.style.display === "table-row") { row.style.display = "none"; btn.classList.remove("rotated"); } else { row.style.display = "table-row"; btn.classList.add("rotated"); } }
        function formatDetails(txt) { let parts = txt.split(" ||| "); let incorrects = parts.filter(p => p.includes("INCORRECTO")); if(incorrects.length === 0) return '<span style="color:green">Examen perfecto</span>'; return incorrects.map(inc => `<div class="incorrect-item"><i class="fas fa-times-circle"></i> ${inc.replace('[','').replace(']','').replace('(INCORRECTO)','')}</div>`).join(''); }
        function exportToExcel(){ if(reportDataForExcel.length===0) return alert("No hay datos"); const ws = XLSX.utils.json_to_sheet(reportDataForExcel); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Reporte"); XLSX.writeFile(wb, 'Reporte_Geincos.xlsx'); }

        async function loadCalidadData() { const { data } = await sbClient.from('sesiones_roleplay').select('*').order('created_at', {ascending:false}); let h = ''; if(data) data.forEach(item => { const statusClass = item.puntaje_total >= 14 ? 'pass' : 'fail'; const det = JSON.stringify(item.detalle_json).replace(/"/g, '&quot;'); h += `<div class="calidad-card ${statusClass}" onclick="verDetalleCalidad('${det}', ${item.puntaje_total})"><div class="c-user">${item.usuario}</div><span class="c-date">${new Date(item.created_at).toLocaleString()}</span><div class="c-score">${item.puntaje_total}/20</div><div class="c-tag">${item.escenario || 'Roleplay'}</div></div>`; }); document.getElementById('calidadGrid').innerHTML = h; }
        function verDetalleCalidad(jsonStr, score) { const data = JSON.parse(jsonStr); let colorScore = score >= 14 ? 'var(--success)' : 'var(--danger)'; let html = `<div class="q-header"><div><h4 style="color:#64748b;margin:0;text-transform:uppercase;font-size:0.9rem">Nota Final</h4><div class="q-score-big" style="color:${colorScore}">${score} / 20</div></div><div><i class="fas ${score >= 14 ? 'fa-smile' : 'fa-frown'}" style="font-size:4rem;color:${colorScore};opacity:0.2"></i></div></div><div class="q-grid-items">`; for (const key in data.criterios) { const pt = data.criterios[key].puntaje; const statusClass = pt > 0 ? 'ok' : 'bad'; const icon = pt > 0 ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : '<i class="fas fa-times-circle" style="color:var(--danger)"></i>'; html += `<div class="q-item ${statusClass}"><span style="font-weight:600;font-size:0.9rem;color:var(--text-main)">${key}</span>${icon}</div>`; } html += `</div>`; if(data.feedback) html += `<div class="q-feedback-box"><div><strong style="display:block;margin-bottom:5px;color:#b45309">Feedback de la IA:</strong>${data.feedback}</div></div>`; document.getElementById('calidadDetalle').innerHTML = html; document.getElementById('modalCalidad').style.display = 'flex'; }
        async function openConfigCalidad() { const { data } = await sbClient.from('config_calidad').select('criterios').limit(1).maybeSingle(); const list = document.getElementById('criteriaList'); list.innerHTML = ''; let criterios = data && data.criterios ? data.criterios : [{"nombre": "Saludo intuitivo", "puntos": 3}]; criterios.forEach(c => addCriteriaRow(c.nombre, c.puntos)); document.getElementById('modalConfigCalidad').style.display = 'flex'; }
        function addCriteriaRow(name = "", points = "") { const list = document.getElementById('criteriaList'); const div = document.createElement('div'); div.className = 'key-row criteria-row'; div.style.gridTemplateColumns = "2fr 1fr 40px"; div.style.display = "grid"; div.innerHTML = `<input type="text" class="form-control c-name" value="${name}" placeholder="Nombre del criterio"><input type="number" class="form-control c-points" value="${points}" placeholder="Pts"><button class="btn-remove-key" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`; list.appendChild(div); }
        async function saveConfigCalidad() { const rows = document.querySelectorAll('.criteria-row'); const newCriteria = []; rows.forEach(r => { const name = r.querySelector('.c-name').value.trim(); const points = parseInt(r.querySelector('.c-points').value.trim()) || 0; if(name) newCriteria.push({ nombre: name, puntos: points }); }); const { data: existing } = await sbClient.from('config_calidad').select('id').limit(1).maybeSingle(); if (existing) await sbClient.from('config_calidad').update({ criterios: newCriteria }).eq('id', existing.id); else await sbClient.from('config_calidad').insert([{ criterios: newCriteria }]); alert('Configuración guardada.'); closeModals(); }
        async function loadRoleplays() { const { data } = await sbClient.from('roleplay_scenarios').select('*').order('id'); let h = ''; if(data) data.forEach(r => { let d = r.datos_cliente || {}; let k = r.api_keys ? r.api_keys.length : 0; h += `<tr><td><b>${r.titulo}</b></td><td>${d.nombre||'-'}</td><td>${d.deuda||'-'}</td><td><span style="background:#e0e7ff;padding:2px 5px;border-radius:5px">${k} Keys</span></td><td><button class="btn-icon btn-edit" onclick="editRoleplay('${r.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('roleplay_scenarios','${r.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbRoleplays').innerHTML = h; }
        function addApiKeyField(value = "") { const container = document.getElementById('apiKeysContainer'); const div = document.createElement('div'); div.className = 'key-row'; div.innerHTML = `<input type="text" class="form-control key-input" value="${value}" placeholder="sk-..."><button class="btn-remove-key" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`; container.appendChild(div); }
        async function saveRoleplay() { const id = document.getElementById('rpId').value; const keys = []; document.querySelectorAll('.key-input').forEach(input => { if(input.value.trim()) keys.push(input.value.trim()); }); const data = { titulo: document.getElementById('rpTitulo').value, prompt_sistema: document.getElementById('rpPrompt').value, datos_cliente: { nombre: document.getElementById('rpCliNombre').value, producto: document.getElementById('rpCliProd').value, deuda: document.getElementById('rpCliDeuda').value, mora: document.getElementById('rpCliMora').value, capital: document.getElementById('rpCliCapital').value, campana: document.getElementById('rpCliCampana').value }, api_keys: keys }; if(id) await sbClient.from('roleplay_scenarios').update(data).eq('id', id); else await sbClient.from('roleplay_scenarios').insert([data]); closeModals(); loadRoleplays(); }
        async function editRoleplay(id) { const { data } = await sbClient.from('roleplay_scenarios').select('*').eq('id', id).single(); if(data) { document.getElementById('rpId').value = data.id; document.getElementById('rpTitulo').value = data.titulo; document.getElementById('rpPrompt').value = data.prompt_sistema; let d = data.datos_cliente || {}; document.getElementById('rpCliNombre').value = d.nombre || ''; document.getElementById('rpCliProd').value = d.producto || ''; document.getElementById('rpCliDeuda').value = d.deuda || ''; document.getElementById('rpCliMora').value = d.mora || ''; document.getElementById('rpCliCapital').value = d.capital || ''; document.getElementById('rpCliCampana').value = d.campana || ''; const container = document.getElementById('apiKeysContainer'); container.innerHTML = ''; if(data.api_keys && data.api_keys.length > 0) { data.api_keys.forEach(k => addApiKeyField(k)); } else { addApiKeyField(); } openModal('modalRoleplay'); } }
        function clearRoleplayForm() { document.getElementById('rpId').value = ''; document.getElementById('rpTitulo').value = ''; document.getElementById('rpPrompt').value = ''; document.getElementById('rpCliNombre').value = ''; document.getElementById('rpCliProd').value = ''; document.getElementById('rpCliDeuda').value = ''; document.getElementById('rpCliMora').value = ''; document.getElementById('rpCliCapital').value = ''; document.getElementById('rpCliCampana').value = ''; document.getElementById('apiKeysContainer').innerHTML = ''; addApiKeyField(); }
        async function loadCourses(){ const {data}=await sbClient.from('cursos').select('*').neq('tipo','simulador'); let h=''; data.forEach(c=>{ h+=`<tr><td>${c.modulo}</td><td>${c.titulo}</td><td>${c.tipo}</td><td><button class="btn-icon btn-edit" onclick="editCourse('${c.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('cursos','${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbCourses').innerHTML=h; }
        async function editCourse(id) { const { data } = await sbClient.from('cursos').select('*').eq('id', id).single(); if (data) { document.getElementById('cId').value = data.id; document.getElementById('cMod').value = data.modulo; document.getElementById('cTitle').value = data.titulo; document.getElementById('cType').value = data.tipo; document.getElementById('cUrl').value = data.video || ''; openModal('modalCourse'); } }
        async function saveCourse() { const id = document.getElementById('cId').value; const courseData = { modulo: document.getElementById('cMod').value, titulo: document.getElementById('cTitle').value, tipo: document.getElementById('cType').value, video: document.getElementById('cUrl').value }; if (id) { await sbClient.from('cursos').update(courseData).eq('id', id); } else { await sbClient.from('cursos').insert([courseData]); } closeModals(); loadCourses(); }
        function clearCourseForm() { document.getElementById('cId').value = ''; document.getElementById('cMod').value = ''; document.getElementById('cTitle').value = ''; document.getElementById('cType').value = 'video'; document.getElementById('cUrl').value = ''; }
        async function retest(id){ if(confirm('¿Permitir reintento?')){ await sbClient.from('evaluaciones').update({retest_active:true}).eq('id',id); loadReports(); } }
        async function cert(u,c){ if(confirm('¿Otorgar certificado?')){ const {data}=await sbClient.from('usuarios').select('id,certificados_json').eq('usuario',u).single(); let cs=data.certificados_json?JSON.parse(data.certificados_json):[]; if(!cs.includes(c)) cs.push(c); await sbClient.from('usuarios').update({certificados_json:JSON.stringify(cs)}).eq('id',data.id); alert('Otorgado'); } }
        async function loadExamCourses(){ const {data}=await sbClient.from('cursos').select('titulo'); const s=document.getElementById('selCourseEx'); s.innerHTML=''; data.forEach(c=>s.innerHTML+=`<option>${c.titulo}</option>`); loadQuestions(); }
        async function loadQuestions(){ const c=document.getElementById('selCourseEx').value; const {data}=await sbClient.from('preguntas').select('*').eq('curso',c); let h=''; if(data) data.forEach((q,index)=>{ h+=`<tr><td><button class="btn-toggle-row" onclick="toggleRow('row-${q.id}', this)"><i class="fas fa-chevron-down"></i></button></td><td>${q.pregunta}</td><td>${q.correcta}</td><td><button class="btn-icon btn-edit" onclick="editQuestion('${q.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('preguntas','${q.id}')"><i class="fas fa-trash"></i></button></td></tr><tr id="row-${q.id}" class="exam-detail-row"><td colspan="4"><div class="exam-detail-content"><div class="exam-opt"><strong>Opción 1</strong>${q.opcion1}</div><div class="exam-opt"><strong>Opción 2</strong>${q.opcion2}</div><div class="exam-opt"><strong>Opción 3</strong>${q.opcion3}</div></div></td></tr>`; }); document.getElementById('tbQuestions').innerHTML=h; }
        async function editQuestion(id){ const {data} = await sbClient.from('preguntas').select('*').eq('id',id).single(); if(data){ document.getElementById('qId').value = data.id; document.getElementById('qTxt').value = data.pregunta; document.getElementById('op1').value = data.opcion1; document.getElementById('op2').value = data.opcion2; document.getElementById('op3').value = data.opcion3; document.getElementById('qCorrect').value = data.correcta; openModal('modalQuestion'); } }
        function clearQuestionForm(){ document.getElementById('qId').value=''; document.getElementById('qTxt').value=''; document.getElementById('op1').value=''; document.getElementById('op2').value=''; document.getElementById('op3').value=''; }
        async function saveQuestion(){ const id = document.getElementById('qId').value; const data = { curso:document.getElementById('selCourseEx').value, pregunta:document.getElementById('qTxt').value, opcion1:document.getElementById('op1').value, opcion2:document.getElementById('op2').value, opcion3:document.getElementById('op3').value, correcta:document.getElementById('qCorrect').value }; if(id) await sbClient.from('preguntas').update(data).eq('id',id); else await sbClient.from('preguntas').insert([data]); closeModals(); loadQuestions(); }
        async function loadSims(){ const {data}=await sbClient.from('cursos').select('*').eq('tipo','simulador'); let h=''; data.forEach(s=>{ h+=`<tr><td>${s.titulo}</td><td>${s.descripcion}</td><td><button class="btn-icon btn-edit" onclick="editSim('${s.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('cursos','${s.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbSims').innerHTML=h; }
        function openSimEditor(mode){ document.getElementById('sims').style.display='none'; document.getElementById('sims-editor').style.display='flex'; if(mode==='create'){ currentSimId=null; editorSteps=[{cliente:"Hola...", opciones:["Respuesta A"], correcta:0}]; document.getElementById('simTitle').value=''; document.getElementById('simDesc').value=''; renderSteps(); } }
        async function editSim(id){ const {data}=await sbClient.from('cursos').select('*').eq('id',id).single(); currentSimId=id; document.getElementById('simTitle').value=data.titulo; document.getElementById('simDesc').value=data.descripcion; editorSteps=JSON.parse(data.data_juego); document.getElementById('sims').style.display='none'; document.getElementById('sims-editor').style.display='flex'; renderSteps(); }
        function closeSimEditor(){ document.getElementById('sims-editor').style.display='none'; document.getElementById('sims').style.display='flex'; }
        function renderSteps(){ let h=''; editorSteps.forEach((s, i) => { let optsHtml = ''; s.opciones.forEach((opt, j) => { optsHtml += `<div style="display:flex; gap:5px; margin-bottom:5px; align-items:center"><input type="radio" name="corr${i}" ${s.correcta==j?'checked':''} onclick="updateStep(${i},'correcta',${j})"><input class="form-control" value="${opt}" oninput="updateOpt(${i},${j},this.value)" placeholder="Opción ${j+1}"><button class="btn-icon" style="background:#ef4444; width:25px; height:25px" onclick="removeOpt(${i},${j})"><i class="fas fa-times"></i></button></div>`; }); h += `<div class="step-card"><h4>Paso ${i + 1}</h4><i class="fas fa-trash delete-step" onclick="removeStep(${i})"></i><div class="form-group"><label>Cliente Dice:</label><input class="form-control" value="${s.cliente}" oninput="updateStep(${i}, 'cliente', this.value)"></div><div class="form-group"><label>Respuestas:</label>${optsHtml}<button class="btn-add-opt" onclick="addOpt(${i})">+ Agregar Opción</button></div></div>`; }); document.getElementById('stepsContainer').innerHTML = h; }
        function addStep(){ editorSteps.push({cliente: "...", opciones: ["Opción 1"], correcta: 0}); renderSteps(); }
        function removeStep(i){ editorSteps.splice(i, 1); renderSteps(); }
        function updateStep(i, f, v){ editorSteps[i][f] = v; }
        function updateOpt(i, j, v){ editorSteps[i].opciones[j] = v; }
        function addOpt(stepIndex) { editorSteps[stepIndex].opciones.push(""); renderSteps(); }
        function removeOpt(stepIndex, optIndex) { if(editorSteps[stepIndex].opciones.length <= 1) return alert("Mínimo una opción."); editorSteps[stepIndex].opciones.splice(optIndex, 1); if(editorSteps[stepIndex].correcta >= editorSteps[stepIndex].opciones.length) editorSteps[stepIndex].correcta = 0; renderSteps(); }
        async function saveSim(){ const s = { titulo: document.getElementById('simTitle').value, descripcion: document.getElementById('simDesc').value, modulo: 'Entrenamiento', tipo: 'simulador', data_juego: JSON.stringify(editorSteps), categoria: 'General' }; if(currentSimId) await sbClient.from('cursos').update(s).eq('id',currentSimId); else await sbClient.from('cursos').insert([s]); alert('Guardado'); closeSimEditor(); loadSims(); }
        async function loadDuels(){ const {data}=await sbClient.from('duelos').select('*'); let h=''; if(data) data.forEach(d=>h+=`<tr><td>${new Date(d.created_at).toLocaleDateString()}</td><td>${d.retador} vs ${d.oponente}</td><td>${d.score_retador||0}-${d.score_oponente||0}</td><td>${d.estado}</td></tr>`); document.getElementById('tbDuels').innerHTML=h; }
        async function loadChatUsers(){ const {data}=await sbClient.from('usuarios').select('usuario').neq('rol','admin'); let h=''; data.forEach(u=>h+=`<div class="chat-user-item" onclick="openChat('${u.usuario}')"><div class="avatar">${u.usuario[0]}</div><div>${u.usuario}</div></div>`); document.getElementById('chatUserList').innerHTML=h; }
        async function openChat(u){ currentChatUser=u; const {data}=await sbClient.from('chat').select('*').or(`and(remitente.eq.Admin,destinatario.eq.${u}),and(remitente.eq.${u},destinatario.eq.Admin)`).order('created_at',{ascending:true}); let h=''; data.forEach(m=>h+=`<div class="msg-row ${m.remitente=='Admin'?'me':''}"><div class="msg-bubble">${m.mensaje}</div></div>`); document.getElementById('chatMessages').innerHTML=h; }
        async function sendMessage(){ const t=document.getElementById('chatInput').value; if(t && currentChatUser){ await sbClient.from('chat').insert([{remitente:'Admin', destinatario:currentChatUser, mensaje:t, leido:false}]); document.getElementById('chatInput').value=''; openChat(currentChatUser); } }
        async function del(t,id){ if(confirm('Eliminar?')) { await sbClient.from(t).delete().eq('id',id); if(t==='roleplay_scenarios') loadRoleplays(); else if(t==='preguntas') loadQuestions(); else if(t==='cursos') loadCourses(); else location.reload(); } }
    </script>
</body>
</html>