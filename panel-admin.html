<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geincos Admin | Gestión Profesional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #4f46e5; --bg-body: #f3f4f6; --surface: #ffffff; --text-main: #1e293b; --text-muted: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --border: #e2e8f0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--surface); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .brand i { font-size: 1.5rem; color: var(--primary); }
        .brand span { font-size: 1.25rem; font-weight: 800; color: var(--text-main); }
        .menu-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin: 20px 0 10px 10px; }
        .menu-item { padding: 12px 16px; color: var(--text-muted); border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; text-decoration: none; position: relative; }
        .menu-item:hover { background: #eef2ff; color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; }
        .menu-badge { position: absolute; right: 15px; background: #ef4444; color: white; font-size: 0.7rem; font-weight: bold; padding: 2px 8px; border-radius: 10px; display: none; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 32px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: center; }
        h2 { font-size: 1.8rem; font-weight: 700; }
        
        .content-section { display: none; flex-direction: column; height: 100%; }
        .content-section.active { display: flex; }

        /* TABLES & CARDS */
        .table-container { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; max-height: 80vh; margin-top: 15px; }
        .table-scroll { overflow-y: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 16px 24px; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); position: sticky; top: 0; z-index: 10; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; vertical-align: middle; }
        tr:hover { background: #f8fafc; }

        /* BUTTONS & CONTROLS */
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: #e2e8f0; color: var(--text-main); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-icon { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; color: white; transition: 0.2s; }
        .btn-edit { background: var(--warning); }
        .btn-delete { background: var(--danger); }
        .btn-assign { background: var(--success); }

        /* FILTROS REPORTES Y BOTONES ESPECIALES */
        .report-controls { display: flex; justify-content: space-between; align-items: center; background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); }
        .filter-select { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; width: 200px; font-size: 0.9rem; }
        .btn-general { background: #6366f1; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; gap: 8px; align-items: center; }
        .btn-detail { background: #10b981; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; gap: 8px; align-items: center; margin-left: 10px; }
        
        /* BOTONES CERTIFICAR Y RETEST */
        .btn-certify { background: linear-gradient(135deg, #d97706, #fbbf24); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; box-shadow: 0 2px 5px rgba(217, 119, 6, 0.3); }
        .btn-certify:hover { transform: scale(1.05); }
        .btn-retest { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .btn-expand { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 1rem; padding: 5px; }

        /* DETALLE DESPLEGABLE */
        .detail-row { display: none; background-color: #fefce8; } 
        .detail-row.show { display: table-row; }
        .detail-content { padding: 20px 30px; font-size: 0.9rem; color: #475569; line-height: 1.6; }
        .incorrect-item { color: #b91c1c; margin-bottom: 5px; display: flex; align-items: flex-start; gap: 8px; }

        /* CHAT STYLES */
        .chat-layout { display: flex; height: 75vh; background: #fff; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #f1f5f9; }
        .chat-sidebar { width: 320px; background: #fff; border-right: 1px solid #f1f5f9; display: flex; flex-direction: column; }
        .chat-header-list { padding: 20px; border-bottom: 1px solid #f1f5f9; }
        .chat-user-list { flex: 1; overflow-y: auto; }
        .chat-user-item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f8fafc; }
        .chat-user-item:hover { background: #f8fafc; }
        .chat-user-item.active { background: #eef2ff; border-right: 3px solid var(--primary); }
        .avatar { width: 40px; height: 40px; background: #e0e7ff; color: var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; flex-shrink: 0; }
        .user-badge { background: #ef4444; color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: auto; }
        
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #f8fafc; }
        .chat-header-main { padding: 15px 25px; background: #fff; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 15px; font-weight: 700; height: 70px; }
        .chat-messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg-row { display: flex; width: 100%; margin-bottom: 5px; }
        .msg-row.me { justify-content: flex-end; }
        .msg-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .msg-row.me .msg-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-row.other .msg-bubble { background: #fff; color: var(--text-main); border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
        .chat-input-area { padding: 20px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; align-items: center; gap: 15px; }
        .chat-input-wrapper { flex: 1; background: #f1f5f9; border-radius: 25px; padding: 5px 20px; display: flex; align-items: center; }
        .chat-input { flex: 1; background: transparent; border: none; padding: 10px 0; outline: none; font-size: 0.95rem; }
        .btn-send { width: 40px; height: 40px; background: var(--primary); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* SIMULATOR & MODALS */
        .sim-editor { background: white; padding: 25px; border-radius: 16px; height: 100%; display: flex; flex-direction: column; gap: 20px; }
        .step-card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f8fafc; position: relative; }
        .step-card h4 { margin: 0 0 10px 0; color: var(--primary); }
        .step-card .delete-step { position: absolute; top: 10px; right: 10px; color: var(--danger); cursor: pointer; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 500px; max-width: 95%; padding: 30px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.2s; }
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><i class="fas fa-cube"></i><span>Geincos Admin</span></div>
        <div class="menu-label">Analítica</div>
        <a href="dashboard.html" class="menu-item"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <div class="menu-item" onclick="nav('reports', this)"><i class="fas fa-file-invoice"></i> Reportes</div>
        <div class="menu-item" onclick="nav('duels', this)"><i class="fas fa-trophy"></i> Resultados PvP</div>
        <div class="menu-item" onclick="nav('chat', this)">
            <i class="fas fa-comments"></i> Mensajería 
            <span class="menu-badge" id="chatBadge">0</span>
        </div>
        <div class="menu-label">Gestión</div>
        <div class="menu-item active" onclick="nav('users', this)"><i class="fas fa-users"></i> Usuarios</div>
        <div class="menu-item" onclick="nav('courses', this)"><i class="fas fa-book"></i> Materiales</div>
        <div class="menu-item" onclick="nav('exams', this)"><i class="fas fa-clipboard-check"></i> Exámenes</div>
        <div class="menu-item" onclick="nav('sims', this)"><i class="fas fa-gamepad"></i> Simuladores</div>
        <div class="menu-item" style="margin-top:auto; color:var(--danger)" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </div>
    </div>

    <div class="main-content">
        
        <div id="reports" class="content-section">
            <div class="header"><h2>Reporte de Evaluaciones y Certificación</h2></div>
            <div class="report-controls">
                <select id="filterGroup" class="filter-select" onchange="loadReports()">
                    <option value="all">Todos los grupos</option>
                </select>
                <div>
                    <button class="btn-general" onclick="exportToExcel('general')"><i class="fas fa-download"></i> General</button>
                    <button class="btn-detail" onclick="exportToExcel('detailed')"><i class="fas fa-list"></i> Detallado</button>
                </div>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table id="reportsTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th>FECHA</th>
                                <th>USUARIO</th>
                                <th>CURSO</th>
                                <th>MÓDULO</th>
                                <th>NOTA</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="tbReports"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="users" class="content-section active">
            <div class="header">
                <h2>Gestión de Usuarios</h2>
                <button class="btn-primary" onclick="openModal('modalUser', 'create')"><i class="fas fa-plus"></i> Nuevo Usuario</button>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead><tr><th>Usuario</th><th>DNI</th><th>Grupo</th><th>Rol</th><th>Acciones</th></tr></thead>
                        <tbody id="tbUsers"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="courses" class="content-section">
            <div class="header">
                <h2>Materiales de Capacitación</h2>
                <button class="btn-primary" onclick="openModal('modalCourse', 'create')"><i class="fas fa-plus"></i> Nuevo Material</button>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead><tr><th>Módulo</th><th>Título</th><th>Tipo</th><th>Acciones</th></tr></thead>
                        <tbody id="tbCourses"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="exams" class="content-section">
            <div class="header">
                <h2>Banco de Preguntas</h2>
                <button class="btn-primary" onclick="createExamShortCut()"><i class="fas fa-plus"></i> Crear Nuevo Examen</button>
            </div>
            <div class="table-container" style="padding: 20px;">
                <p style="color:#666; margin-bottom:10px;">Selecciona el examen para ver sus preguntas:</p>
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <select id="selCourseEx" class="form-control" onchange="loadQuestions()"><option>Cargando...</option></select>
                    <button class="btn-primary" onclick="openModal('modalQuestion', 'create')"><i class="fas fa-plus"></i> Agregar Pregunta</button>
                </div>
                <div class="table-scroll">
                    <table>
                        <thead><tr><th>Pregunta</th><th>Respuesta Correcta</th><th>Pts</th><th>Acción</th></tr></thead>
                        <tbody id="tbQuestions"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sims" class="content-section">
            <div class="header">
                <h2>Simuladores Interactivos</h2>
                <button class="btn-primary" onclick="openSimEditor('create')"><i class="fas fa-plus"></i> Crear Nuevo</button>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead><tr><th>Título</th><th>Descripción</th><th>Acciones</th></tr></thead>
                        <tbody id="tbSims"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sims-editor" class="content-section">
            <div class="header">
                <h2>Editor de Escenarios</h2>
                <div style="display:flex; gap:10px">
                    <button class="btn-secondary" onclick="closeSimEditor()">Cancelar</button>
                    <button class="btn-primary" onclick="saveSim()"><i class="fas fa-save"></i> Guardar</button>
                </div>
            </div>
            <div class="sim-editor">
                <div style="display:flex; gap:15px;">
                    <input id="simTitle" class="form-control" placeholder="Título del Simulador">
                    <input id="simDesc" class="form-control" placeholder="Descripción breve">
                </div>
                <hr style="border:0; border-top:1px solid #eee; width:100%">
                <div id="stepsContainer" style="flex:1; overflow-y:auto;"></div>
                <button class="btn-primary" style="align-self:center" onclick="addStep()">+ Agregar Paso</button>
            </div>
        </div>

        <div id="chat" class="content-section">
            <div class="header"><h2>Mensajería en Tiempo Real</h2></div>
            <div class="chat-layout">
                <div class="chat-sidebar">
                    <div class="chat-header-list"><h3>Chats Recientes</h3></div>
                    <div class="chat-user-list" id="chatUserList"></div>
                </div>
                <div class="chat-main">
                    <div class="chat-header-main">
                        <div class="avatar" id="headerAvatar" style="display:none">?</div>
                        <span id="headerName">Selecciona un chat</span>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#94a3b8;">
                            <i class="fas fa-comments" style="font-size:3rem; margin-bottom:15px; opacity:0.5;"></i>
                            <p>Tus mensajes aparecerán aquí.</p>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <input type="text" id="chatInput" class="chat-input" placeholder="Escribe tu mensaje..." onkeypress="handleEnter(event)">
                        </div>
                        <button class="btn-send" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="duels" class="content-section">
            <div class="header"><h2>Resultados Duelos PvP</h2></div>
            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead><tr><th>Fecha</th><th>Retador vs Oponente</th><th>Score</th><th>Ganador</th></tr></thead>
                        <tbody id="tbDuels"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="modalUser">
        <div class="modal-box">
            <h3>Datos de Usuario</h3>
            <input type="hidden" id="uId">
            <div class="form-group"><label>Usuario</label><input id="uUser" class="form-control"></div>
            <div class="form-group"><label>DNI</label><input id="uDni" class="form-control"></div>
            <div class="form-group"><label>Contraseña</label><input id="uPass" class="form-control" placeholder="Dejar en blanco para no cambiar"></div>
            <div class="form-group"><label>Grupo</label><input id="uTag" class="form-control" placeholder="Ej: G-01"></div>
            <div class="form-group"><label>Correo</label><input id="uEmail" class="form-control"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModals()">Cancelar</button>
                <button class="btn-primary" onclick="saveUser()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalCourse">
        <div class="modal-box">
            <h3 id="modalCourseTitle">Material de Capacitación</h3>
            <input type="hidden" id="cId">
            <div class="form-group"><label>Módulo (Carpeta)</label><input id="cMod" class="form-control" placeholder="Ej: NEGOCIACION"></div>
            <div class="form-group"><label>Título</label><input id="cTitle" class="form-control"></div>
            <div class="form-group"><label>Descripción</label><input id="cDesc" class="form-control"></div>
            <div class="form-group"><label>Categoría</label><input id="cCat" class="form-control"></div>
            <div class="form-group"><label>Tipo</label>
                <select id="cType" class="form-control" onchange="toggleCourseFields()">
                    <option value="video">Video (YouTube)</option>
                    <option value="pdf">Documento PDF</option>
                    <option value="examen">Examen</option>
                </select>
            </div>
            <div class="form-group" id="urlField"><label>URL / Enlace</label><input id="cUrl" class="form-control"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModals()">Cancelar</button>
                <button class="btn-primary" onclick="saveCourse()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalAssign">
        <div class="modal-box">
            <h3>Asignar Cursos a <span id="assignTarget" style="color:var(--primary)"></span></h3>
            <div id="assignList" style="max-height:300px; overflow-y:auto; margin:15px 0; border:1px solid #eee; padding:10px; border-radius:8px;"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModals()">Cerrar</button>
                <button class="btn-primary" onclick="saveAssignments()">Guardar Asignaciones</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalQuestion">
        <div class="modal-box">
            <h3>Gestión de Pregunta</h3>
            <input type="hidden" id="qId">
            <div class="form-group"><label>Enunciado</label><input id="qTxt" class="form-control"></div>
            <div class="form-group"><label>Opción 1</label><input id="op1" class="form-control"></div>
            <div class="form-group"><label>Opción 2</label><input id="op2" class="form-control"></div>
            <div class="form-group"><label>Opción 3</label><input id="op3" class="form-control"></div>
            <div class="form-group"><label>Correcta</label>
                <select id="qCorrect" class="form-control">
                    <option value="op1">Opción 1</option><option value="op2">Opción 2</option><option value="op3">Opción 3</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModals()">Cancelar</button>
                <button class="btn-primary" onclick="saveQuestion()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://xgvfcmadsprjyljtpooo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndmZjbWFkc3ByanlsanRwb29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODMxNjAsImV4cCI6MjA4MjE1OTE2MH0.XYBbKFE17PfyYMn2SNL5UJrCQmDRbimTQO0jpbX1Zd0';
        const sbClient = supabase.createClient(SB_URL, SB_KEY);

        let currentAssignUser = '', currentChatUser = '', chatSubscription = null;
        let editorSteps = [], currentSimId = null;
        const audioNotification = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        window.onload = () => { 
            loadUsers(); loadCourses(); loadExamCourses(); loadSims(); loadReports(); loadDuels(); 
            initMasterRealtime(); loadChatUsers(); checkChat(); 
        };

        function nav(id, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
            if(id === 'chat') { loadChatUsers(); if(currentChatUser) scrollToBottom(); }
            if(id === 'exams') loadExamCourses(); 
            if(id === 'reports') loadReports();
        }

        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        function openModal(id, mode) { 
            document.getElementById(id).style.display='flex';
            if(mode === 'create') {
                if(id === 'modalCourse') { document.getElementById('cId').value = ''; document.getElementById('cTitle').value = ''; document.getElementById('cUrl').value = ''; document.getElementById('cType').value='video'; toggleCourseFields(); document.getElementById('modalCourseTitle').innerText = 'Nuevo Material'; }
                if(id === 'modalQuestion') { document.getElementById('qId').value = ''; document.getElementById('qTxt').value = ''; document.getElementById('op1').value = ''; document.getElementById('op2').value = ''; document.getElementById('op3').value = ''; }
                if(id === 'modalUser') { document.getElementById('uId').value=''; document.getElementById('uUser').value=''; document.getElementById('uDni').value=''; document.getElementById('uTag').value=''; document.getElementById('uPass').value=''; document.getElementById('uEmail').value=''; }
            }
        }
        function logout() { localStorage.clear(); window.location.href='index.html'; }

        // --- REPORTES Y CERTIFICACIÓN ---
        async function loadReports() {
            const filterGroup = document.getElementById('filterGroup').value;
            let query = sbClient.from('evaluaciones').select('*').order('created_at', {ascending:false});
            if(filterGroup && filterGroup !== 'all') query = query.eq('grupo', filterGroup);
            const { data: evals } = await query;

            const { data: users } = await sbClient.from('usuarios').select('usuario, correo, etiqueta');
            const { data: courses } = await sbClient.from('cursos').select('titulo, modulo');
            
            const userMap = {}; const groups = new Set();
            users.forEach(u => { userMap[u.usuario] = u.correo || 'Sin correo'; if(u.etiqueta) groups.add(u.etiqueta); });
            const courseMap = {};
            if(courses) courses.forEach(c => courseMap[c.titulo] = c.modulo);

            const sel = document.getElementById('filterGroup');
            if(sel.options.length === 1) groups.forEach(g => { sel.innerHTML += `<option value="${g}">${g}</option>`; });

            let h = '';
            evals.forEach(r => {
                const email = userMap[r.usuario] || '-';
                const modName = courseMap[r.curso] || 'General';
                const detalles = r.detalle ? formatDetails(r.detalle) : '<span style="color:#999">Sin detalle</span>';
                const rowId = `detail-${r.id}`;
                
                // Botón Certificar
                const btnCert = `<button class="btn-certify" onclick="issueCertificate('${r.usuario}', '${modName}')"><i class="fas fa-medal"></i> Certificar</button>`;
                // Botón Retest
                const btnRetest = r.retest_active ? `<span style="color:var(--success); font-weight:bold; font-size:0.8rem;"><i class="fas fa-check"></i> Activo</span>` : `<button class="btn-retest" onclick="enableRetest(${r.id})"><i class="fas fa-sync-alt"></i> Retest</button>`;

                h += `
                <tr>
                    <td><button class="btn-expand" onclick="toggleDetail('${rowId}')"><i class="fas fa-chevron-down"></i></button></td>
                    <td>${new Date(r.created_at).toLocaleDateString()}</td>
                    <td><b>${r.usuario}</b></td>
                    <td>${r.curso}</td>
                    <td><span style="background:#e0e7ff; color:#4338ca; padding:3px 8px; border-radius:10px; font-size:0.8rem; font-weight:700">${modName}</span></td>
                    <td><b>${r.nota}</b></td>
                    <td style="display:flex; gap:5px;">
                        ${btnCert}
                        ${btnRetest}
                    </td>
                </tr>
                <tr id="${rowId}" class="detail-row">
                    <td colspan="7">
                        <div class="detail-content">
                            <strong>Respuestas Incorrectas:</strong><br><br>
                            ${detalles}
                        </div>
                    </td>
                </tr>`;
            });
            document.getElementById('tbReports').innerHTML = h;
        }

        async function issueCertificate(user, moduleName) {
            if(!confirm(`¿Otorgar certificado de "${moduleName}" al usuario ${user}?`)) return;
            const { data: u } = await sbClient.from('usuarios').select('id, certificados_json').eq('usuario', user).single();
            if(!u) return alert("Usuario no encontrado");
            let certs = []; try { certs = JSON.parse(u.certificados_json || '[]'); } catch(e){}
            if(certs.includes(moduleName)) return alert("El usuario ya tiene este certificado.");
            certs.push(moduleName);
            await sbClient.from('usuarios').update({ certificados_json: JSON.stringify(certs) }).eq('id', u.id);
            alert("¡Certificado otorgado con éxito!");
        }

        async function enableRetest(id) {
            if(confirm("¿Permitir reintento?")) {
                await sbClient.from('evaluaciones').update({ retest_active: true }).eq('id', id);
                alert("Retest habilitado."); loadReports();
            }
        }

        function formatDetails(txt) {
            let parts = txt.split(" ||| ");
            let incorrects = parts.filter(p => p.includes("INCORRECTO"));
            if(incorrects.length === 0) return '<span style="color:green"><i class="fas fa-check"></i> Examen perfecto</span>';
            return incorrects.map(inc => `<div class="incorrect-item"><i class="fas fa-times-circle"></i> ${inc.replace('[','').replace(']','').replace('(INCORRECTO)','')}</div>`).join('');
        }

        function toggleDetail(id) { const row = document.getElementById(id); row.style.display = row.style.display === 'table-row' ? 'none' : 'table-row'; }
        function exportToExcel(type) { const t = document.getElementById("reportsTable"); const wb = XLSX.utils.table_to_book(t, {sheet: "Reporte"}); XLSX.writeFile(wb, `Reporte_${type}.xlsx`); }

        // --- GESTIÓN USUARIOS Y CURSOS ---
        async function loadUsers() { const { data } = await sbClient.from('usuarios').select('*').neq('rol','admin').order('id'); let h = ''; data.forEach(u => { h += `<tr><td><b>${u.usuario}</b></td><td>${u.dni||''}</td><td><span style="background:#f1f5f9; padding:2px 6px; border-radius:4px">${u.etiqueta||'-'}</span></td><td>${u.rol}</td><td><button class="btn-icon btn-assign" onclick="assign('${u.usuario}')"><i class="fas fa-book"></i></button><button class="btn-icon btn-edit" onclick="editUser('${u.id}','${u.usuario}','${u.dni}','${u.etiqueta}','${u.correo||''}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('usuarios', ${u.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbUsers').innerHTML = h; }
        function editUser(id, user, dni, tag, email) { document.getElementById('uId').value = id; document.getElementById('uUser').value = user; document.getElementById('uDni').value = dni; document.getElementById('uTag').value = tag; document.getElementById('uEmail').value = email; document.getElementById('uPass').value = ''; openModal('modalUser'); }
        async function saveUser() { const id = document.getElementById('uId').value; const u = { usuario: document.getElementById('uUser').value, dni: document.getElementById('uDni').value, etiqueta: document.getElementById('uTag').value, correo: document.getElementById('uEmail').value, rol: 'asesor' }; const p = document.getElementById('uPass').value; if(p) u.password = p; if(id) await sbClient.from('usuarios').update(u).eq('id', id); else await sbClient.from('usuarios').insert([u]); closeModals(); loadUsers(); }
        async function assign(user) { currentAssignUser = user; document.getElementById('assignTarget').innerText = user; openModal('modalAssign'); const { data: all } = await sbClient.from('cursos').select('titulo'); const { data: mine } = await sbClient.from('asignaciones').select('cursos_json').eq('usuario', user).maybeSingle(); let my = mine ? JSON.parse(mine.cursos_json) : []; let h = ''; all.forEach(c => { h += `<div style="padding:5px"><input type="checkbox" class="chk-course" value="${c.titulo}" ${my.includes(c.titulo)?'checked':''}> ${c.titulo}</div>`; }); document.getElementById('assignList').innerHTML = h; }
        async function saveAssignments() { const list = Array.from(document.querySelectorAll('.chk-course:checked')).map(c => c.value); await sbClient.from('asignaciones').upsert([{usuario: currentAssignUser, cursos_json: JSON.stringify(list)}], {onConflict: 'usuario'}); alert('Guardado'); closeModals(); }

        async function loadCourses() { const { data } = await sbClient.from('cursos').select('*').neq('tipo','simulador').order('id'); let h = ''; data.forEach(c => { h += `<tr><td>${c.modulo}</td><td><b>${c.titulo}</b></td><td>${c.tipo}</td><td><button class="btn-icon btn-edit" onclick="editCourse('${c.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('cursos', ${c.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbCourses').innerHTML = h; }
        async function editCourse(id) { const { data: c } = await sbClient.from('cursos').select('*').eq('id', id).single(); if(c) { document.getElementById('cId').value = c.id; document.getElementById('cMod').value = c.modulo; document.getElementById('cTitle').value = c.titulo; document.getElementById('cDesc').value = c.descripcion; document.getElementById('cCat').value = c.categoria; document.getElementById('cType').value = c.tipo; document.getElementById('cUrl').value = c.video; toggleCourseFields(); openModal('modalCourse'); } }
        function toggleCourseFields() { document.getElementById('urlField').style.display = (document.getElementById('cType').value === 'examen') ? 'none' : 'block'; }
        async function saveCourse() { const id = document.getElementById('cId').value; const c = { titulo: document.getElementById('cTitle').value, modulo: document.getElementById('cMod').value, descripcion: document.getElementById('cDesc').value, categoria: document.getElementById('cCat').value, tipo: document.getElementById('cType').value, video: document.getElementById('cUrl').value }; if(id) await sbClient.from('cursos').update(c).eq('id', id); else await sbClient.from('cursos').insert([c]); closeModals(); loadCourses(); loadExamCourses(); }

        function createExamShortCut() { openModal('modalCourse', 'create'); document.getElementById('cType').value = 'examen'; toggleCourseFields(); }
        async function loadExamCourses() { const { data } = await sbClient.from('cursos').select('titulo').order('titulo'); const s = document.getElementById('selCourseEx'); s.innerHTML = ''; if(data.length > 0) { data.forEach(c => s.innerHTML += `<option>${c.titulo}</option>`); loadQuestions(); } else s.innerHTML = '<option>No hay cursos</option>'; }
        async function loadQuestions() { const c = document.getElementById('selCourseEx').value; const { data } = await sbClient.from('preguntas').select('*').eq('curso', c); let h = ''; if(data && data.length > 0) data.forEach(q => { h += `<tr><td>${q.pregunta}</td><td>${q.correcta}</td><td>${q.puntaje}</td><td><button class="btn-icon btn-edit" onclick="editQuestion('${q.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('preguntas', ${q.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); else h = '<tr><td colspan="4" style="text-align:center; color:#999">No hay preguntas.</td></tr>'; document.getElementById('tbQuestions').innerHTML = h; }
        async function editQuestion(id) { const { data: q } = await sbClient.from('preguntas').select('*').eq('id', id).single(); if(q) { document.getElementById('qId').value = q.id; document.getElementById('qTxt').value = q.pregunta; document.getElementById('op1').value = q.opcion1; document.getElementById('op2').value = q.opcion2; document.getElementById('op3').value = q.opcion3; document.getElementById('qCorrect').value = q.correcta; openModal('modalQuestion'); } }
        async function saveQuestion() { const id = document.getElementById('qId').value; const q = { curso: document.getElementById('selCourseEx').value, pregunta: document.getElementById('qTxt').value, opcion1: document.getElementById('op1').value, opcion2: document.getElementById('op2').value, opcion3: document.getElementById('op3').value, correcta: document.getElementById('qCorrect').value, puntaje: 2 }; if(id) await sbClient.from('preguntas').update(q).eq('id', id); else await sbClient.from('preguntas').insert([q]); closeModals(); loadQuestions(); }

        async function loadSims() { const { data } = await sbClient.from('cursos').select('*').eq('tipo','simulador'); let h = ''; data.forEach(s => { h += `<tr><td><b>${s.titulo}</b></td><td>${s.descripcion}</td><td><button class="btn-icon btn-edit" onclick="editSim('${s.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('cursos', ${s.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbSims').innerHTML = h; }
        function openSimEditor(mode) { document.getElementById('sims').style.display = 'none'; document.getElementById('sims-editor').style.display = 'flex'; if(mode === 'create') { currentSimId = null; editorSteps = [{cliente: "Hola...", opciones: ["Opción A", "Opción B"], correcta: 0}]; document.getElementById('simTitle').value=''; document.getElementById('simDesc').value=''; renderSteps(); } }
        async function editSim(id) { const { data: s } = await sbClient.from('cursos').select('*').eq('id', id).single(); if(s) { currentSimId = id; document.getElementById('simTitle').value = s.titulo; document.getElementById('simDesc').value = s.descripcion; editorSteps = JSON.parse(s.data_juego); document.getElementById('sims').style.display = 'none'; document.getElementById('sims-editor').style.display = 'flex'; renderSteps(); } }
        function closeSimEditor() { document.getElementById('sims-editor').style.display = 'none'; document.getElementById('sims').style.display = 'flex'; }
        function renderSteps() { let h = ''; editorSteps.forEach((step, i) => { h += `<div class="step-card"><h4>Paso ${i + 1}</h4><i class="fas fa-trash delete-step" onclick="removeStep(${i})"></i><div class="form-group"><label>Cliente Dice:</label><input class="form-control" value="${step.cliente}" oninput="updateStep(${i}, 'cliente', this.value)"></div><div class="form-group"><label>Opciones (Marca la correcta):</label><div style="display:flex; gap:5px; margin-bottom:5px;"><input type="radio" name="corr${i}" ${step.correcta==0?'checked':''} onclick="updateStep(${i},'correcta',0)"><input class="form-control" value="${step.opciones[0]}" oninput="updateOpt(${i},0,this.value)"></div><div style="display:flex; gap:5px;"><input type="radio" name="corr${i}" ${step.correcta==1?'checked':''} onclick="updateStep(${i},'correcta',1)"><input class="form-control" value="${step.opciones[1]}" oninput="updateOpt(${i},1,this.value)"></div></div></div>`; }); document.getElementById('stepsContainer').innerHTML = h; }
        function addStep() { editorSteps.push({cliente: "...", opciones: ["Opción A", "Opción B"], correcta: 0}); renderSteps(); }
        function removeStep(i) { editorSteps.splice(i, 1); renderSteps(); }
        function updateStep(i, f, v) { editorSteps[i][f] = v; }
        function updateOpt(i, o, v) { editorSteps[i].opciones[o] = v; }
        async function saveSim() { const s = { titulo: document.getElementById('simTitle').value, descripcion: document.getElementById('simDesc').value, modulo: 'Entrenamiento', tipo: 'simulador', data_juego: JSON.stringify(editorSteps), categoria: 'General' }; if(currentSimId) await sbClient.from('cursos').update(s).eq('id', currentSimId); else await sbClient.from('cursos').insert([s]); alert('Guardado'); closeSimEditor(); loadSims(); }
        
        function initMasterRealtime() { sbClient.channel('admin-global-listener').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat' }, payload => { if (payload.new.destinatario === 'Admin') { audioNotification.play().catch(()=>{}); checkChat(); loadChatUsers(); if (currentChatUser === payload.new.remitente) { renderMessage(payload.new); markAsRead(payload.new.id); } } }).subscribe(); }
        async function loadChatUsers() { const [{ data: users }, { data: unread }] = await Promise.all([ sbClient.from('usuarios').select('usuario').neq('rol','admin'), sbClient.from('chat').select('remitente').eq('destinatario', 'Admin').eq('leido', false) ]); const counts = {}; unread.forEach(m => { counts[m.remitente] = (counts[m.remitente] || 0) + 1; }); users.sort((a, b) => { const cA = counts[a.usuario] || 0; const cB = counts[b.usuario] || 0; if (cA !== cB) return cB - cA; return a.usuario.localeCompare(b.usuario); }); const listDiv = document.getElementById('chatUserList'); listDiv.innerHTML = ''; users.forEach(u => { const count = counts[u.usuario] || 0; const isActive = (u.usuario === currentChatUser) ? 'active' : ''; const badge = count > 0 ? `<span class="user-badge">${count}</span>` : ''; listDiv.innerHTML += `<div class="chat-user-item ${isActive}" onclick="openChat('${u.usuario}', this)"><div class="avatar">${u.usuario.charAt(0).toUpperCase()}</div><div class="user-info"><div class="user-name">${u.usuario}</div><div class="user-preview">${count > 0 ? '<b style="color:var(--primary)">Nuevos mensajes</b>' : 'Click para abrir'}</div></div>${badge}</div>`; }); }
        async function openChat(user, element) { currentChatUser = user; document.querySelectorAll('.chat-user-item').forEach(e => e.classList.remove('active')); if(element) element.classList.add('active'); document.getElementById('headerAvatar').style.display = 'flex'; document.getElementById('headerAvatar').innerText = user.charAt(0).toUpperCase(); document.getElementById('headerName').innerText = user; await loadMessages(); loadChatUsers(); checkChat(); }
        async function loadMessages() { const box = document.getElementById('chatMessages'); if(box.innerHTML.includes('Selecciona')) box.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa">Cargando...</div>'; const { data } = await sbClient.from('chat').select('*').or(`and(remitente.eq.Admin,destinatario.eq.${currentChatUser}),and(remitente.eq.${currentChatUser},destinatario.eq.Admin)`).order('created_at', { ascending: true }); box.innerHTML = ''; if(data) data.forEach(m => renderMessage(m)); box.scrollTop = box.scrollHeight; await sbClient.from('chat').update({leido:true}).eq('remitente', currentChatUser).eq('destinatario', 'Admin'); }
        function renderMessage(m) { const box = document.getElementById('chatMessages'); const isMe = m.remitente === 'Admin'; const time = new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); box.insertAdjacentHTML('beforeend', `<div class="msg-row ${isMe ? 'me' : 'other'}"><div class="msg-bubble">${m.mensaje}<span class="msg-time">${time}</span></div></div>`); box.scrollTop = box.scrollHeight; }
        async function sendMessage() { const txt = document.getElementById('chatInput').value.trim(); if(!txt || !currentChatUser) return; document.getElementById('chatInput').value = ''; renderMessage({ remitente: 'Admin', mensaje: txt, created_at: new Date() }); await sbClient.from('chat').insert([{ remitente: 'Admin', destinatario: currentChatUser, mensaje: txt, leido: false }]); }
        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        async function markAsRead(id) { await sbClient.from('chat').update({leido:true}).eq('id', id); }
        async function checkChat() { const { count } = await sbClient.from('chat').select('*', { count: 'exact', head: true }).eq('destinatario', 'Admin').eq('leido', false); const b = document.getElementById('chatBadge'); if(count > 0) { b.innerText = count; b.style.display = 'inline-block'; } else b.style.display = 'none'; }
        async function loadDuels() { const { data } = await sbClient.from('duelos').select('*').order('created_at', {ascending:false}); let h = ''; data.forEach(d => { h += `<tr><td>${new Date(d.created_at).toLocaleDateString()}</td><td>${d.retador} vs ${d.oponente}</td><td>${d.score_retador} - ${d.score_oponente}</td><td>${d.ganador||'Pendiente'}</td></tr>`; }); document.getElementById('tbDuels').innerHTML = h; }
        async function del(table, id) { if(confirm('¿Eliminar?')) { await sbClient.from(table).delete().eq('id', id); if(table==='usuarios') loadUsers(); if(table==='cursos') loadCourses(); if(table==='preguntas') loadQuestions(); } }
    </script>
</body>
</html>