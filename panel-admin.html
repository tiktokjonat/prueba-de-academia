<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geincos Admin | Gesti√≥n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #4f46e5; --bg-body: #f3f4f6; --surface: #ffffff; --text-main: #1e293b; --text-muted: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --border: #e2e8f0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--surface); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .brand i { font-size: 1.5rem; color: var(--primary); } .brand span { font-size: 1.25rem; font-weight: 800; }
        .menu-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin: 20px 0 10px 10px; }
        .menu-item { padding: 12px 16px; color: var(--text-muted); border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; text-decoration: none; position: relative; }
        .menu-item:hover { background: #eef2ff; color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 32px; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* FIX DE PESTA√ëAS MEZCLADAS */
        .content-section { display: none; flex-direction: column; height: 100%; } 
        .content-section.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: center; } h2 { font-size: 1.8rem; font-weight: 700; }

        /* TABLAS */
        .table-container { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; max-height: 80vh; }
        .table-scroll { overflow-y: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 1000px; }
        th { background: #f8fafc; text-align: left; padding: 16px 24px; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); position: sticky; top: 0; z-index: 10; text-transform: uppercase; }
        td { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; word-wrap: break-word; }
        tr:hover { background: #f8fafc; }

        /* BOTONES */
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: #e2e8f0; color: var(--text-main); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; color: white; transition: 0.2s; }
        .btn-icon:hover { transform: scale(1.1); }
        .btn-edit { background: var(--warning); } .btn-delete { background: var(--danger); } .btn-assign { background: var(--success); } .btn-eval { background: #8b5cf6; } 
        .btn-add-opt { width: 100%; padding: 8px; background: #eef2ff; color: var(--primary); border: 1px dashed var(--primary); border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: 600; }

        /* MODALES */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 700px; max-width: 95%; padding: 30px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
        .modal-box h3 { margin-top: 0; margin-bottom: 25px; color: var(--text-main); font-size: 1.5rem; font-weight: 700; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.2s; font-size: 0.95rem; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px #e0e7ff; }
        textarea.form-control { resize: vertical; min-height: 80px; }
        
        /* Input File Personalizado */
        .file-input-wrapper { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.2s; position: relative; }
        .file-input-wrapper:hover { border-color: var(--primary); background: #eef2ff; }
        .file-input-wrapper input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; padding-top: 20px; border-top: 1px solid #f1f5f9; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .modal-section { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .modal-section-title { font-size: 0.9rem; font-weight: 700; color: var(--primary); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }

        .key-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .key-row input { flex: 1; font-family: monospace; font-size: 0.85rem; }
        .btn-remove-key { background: #fee2e2; color: #ef4444; border: none; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* CORRECCI√ìN LISTA DE ASIGNACI√ìN */
        .assign-container { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; background: #f8fafc; }
        .assign-item { display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 12px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .assign-item:hover { border-color: var(--primary); background: #eef2ff; }
        .assign-item input { width: 18px; height: 18px; accent-color: var(--primary); margin-right: 10px; }
        .assign-label-box { display: flex; align-items: center; }
        .assign-tag { font-size: 0.7rem; font-weight: 700; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; }
        .tag-course { background: #e0e7ff; color: var(--primary); }
        .tag-sim { background: #fce7f3; color: #db2777; }
        .tag-ia { background: #dcfce7; color: #166534; }

        .btn-toggle-row { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; transition: transform 0.2s; display: block; margin: 0 auto; }
        .btn-toggle-row.rotated { transform: rotate(180deg); color: var(--primary); }
        .exam-detail-row { display: none; background: #f8fafc; }
        .exam-detail-content { padding: 20px; display: flex; flex-direction: column; gap: 15px; max-height: 250px; overflow-y: auto; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; }
        .exam-opt { background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: flex-start; gap: 10px; }
        .exam-opt strong { color: var(--primary); font-size: 0.75rem; text-transform: uppercase; min-width: 70px; margin-top: 3px; }

        /* CALIDAD */
        .calidad-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .calidad-card { background: white; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .calidad-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .calidad-card.pass { border-left: 5px solid var(--success); } .calidad-card.fail { border-left: 5px solid var(--danger); }
        .c-user { font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 5px; }
        .c-score { font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1; }

        .q-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 20px; }
        .q-score-big { font-size: 3.5rem; font-weight: 800; line-height: 1; margin-top: 5px; }
        .q-grid-items { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .q-item { background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .q-item.ok { border-left: 5px solid var(--success); } .q-item.bad { border-left: 5px solid var(--danger); }
        .q-feedback-box { margin-top: 25px; background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 20px; border-radius: 12px; line-height: 1.6; font-size: 0.95rem; display: flex; gap: 15px; }
        .q-improvements-section { margin-top: 25px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .q-imp-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        .q-imp-title { font-weight: 700; color: var(--danger); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .q-error-box { background: #fef2f2; border-left: 4px solid #ef4444; padding: 10px; font-style: italic; color: #7f1d1d; margin-bottom: 10px; font-size: 0.9rem; }
        .q-suggestion-box { background: #f0fdf4; border-left: 4px solid #10b981; padding: 10px; color: #064e3b; font-size: 0.9rem; }
        .q-tech-label { display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; margin-bottom: 5px; }

        .sim-editor { background: white; padding: 25px; border-radius: 16px; height: 100%; display: flex; flex-direction: column; gap: 20px; }
        .step-card { border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; margin-bottom: 15px; background: #f8fafc; position: relative; }
        .step-card h4 { margin: 0 0 15px 0; color: var(--primary); font-size: 1rem; }
        .step-card .delete-step { position: absolute; top: 15px; right: 15px; color: var(--danger); cursor: pointer; font-size: 1.1rem; }
        
        .detail-row { display: none; background-color: #fefce8; } 
        .detail-row.show { display: table-row; }
        .detail-content { padding: 20px 30px; font-size: 0.9rem; color: #475569; line-height: 1.6; }
        .incorrect-item { color: #b91c1c; margin-bottom: 5px; display: flex; align-items: flex-start; gap: 8px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand"><i class="fas fa-cube"></i><span>Geincos Admin</span></div>
        <div class="menu-label">Anal√≠tica</div>
        <a href="dashboard.html" class="menu-item"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <div class="menu-item" onclick="nav('reports', this)"><i class="fas fa-file-invoice"></i> Reportes</div>
        <div class="menu-item" onclick="nav('calidad', this); loadCalidadData()"><i class="fas fa-check-circle"></i> Calidad IA</div>
        <div class="menu-item" onclick="nav('duels', this)"><i class="fas fa-trophy"></i> Resultados PvP</div>
        <div class="menu-label">Gesti√≥n</div>
        <div class="menu-item active" onclick="nav('users', this)"><i class="fas fa-users"></i> Usuarios</div>
        <div class="menu-item" onclick="nav('courses', this)"><i class="fas fa-book"></i> Materiales</div>
        <div class="menu-item" onclick="nav('exams', this)"><i class="fas fa-clipboard-check"></i> Ex√°menes</div>
        <div class="menu-item" onclick="nav('sims', this)"><i class="fas fa-gamepad"></i> Simuladores</div>
        <div class="menu-item" onclick="nav('iaroleplay', this)"><i class="fas fa-robot"></i> IA Roleplay</div>
        <div class="menu-item" style="margin-top:auto; color:var(--danger)" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</div>
    </div>

    <div class="main-content">
        <div id="calidad" class="content-section">
            <div class="header">
                <h2>Evaluaciones IA</h2>
                <button class="btn-primary" onclick="openConfigCalidad()">‚öôÔ∏è Configurar Criterios</button>
            </div>
            <div id="calidadGrid" class="calidad-grid">Cargando...</div>
        </div>

        <div id="iaroleplay" class="content-section">
            <div class="header"><h2>IA Roleplay (Escenarios)</h2><button class="btn-primary" onclick="openModal('modalRoleplay', 'create')">+ Nuevo Escenario</button></div>
            <div class="table-container"><div class="table-scroll"><table><thead><tr><th>T√≠tulo</th><th>Cliente</th><th>Deuda</th><th>Keys</th><th>Acciones</th></tr></thead><tbody id="tbRoleplays"></tbody></table></div></div>
        </div>

        <div id="reports" class="content-section">
            <div class="header"><h2>Reportes y Certificaci√≥n</h2><button class="btn-secondary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Descargar Excel</button></div>
            <div class="table-container"><div class="table-scroll"><table id="reportsTable"><thead><tr><th>Fecha</th><th>Usuario</th><th>Curso</th><th>M√≥dulo</th><th>Nota</th><th>Acciones</th></tr></thead><tbody id="tbReports"></tbody></table></div></div>
        </div>

        <div id="users" class="content-section active">
            <div class="header">
                <h2>Usuarios</h2>
                <div style="display:flex; gap:10px">
                    <button class="btn-secondary" onclick="exportUsersToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn-primary" onclick="openModal('modalUser', 'create')">+ Nuevo</button>
                </div>
            </div>
            <div class="table-container"><div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 250px;">Datos Personales</th>
                            <th>Grupo</th>
                            <th>Tipo</th>
                            <th>Fecha Reg.</th>
                            <th>Estado</th>
                            <th>Detalles</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbUsers"></tbody>
                </table>
            </div></div>
        </div>

        <div id="courses" class="content-section">
            <div class="header"><h2>Materiales</h2><button class="btn-primary" onclick="openModal('modalCourse', 'create')">+ Nuevo</button></div>
            <div class="table-container"><div class="table-scroll"><table><thead><tr><th>M√≥dulo</th><th>T√≠tulo</th><th>Tipo</th><th>Acciones</th></tr></thead><tbody id="tbCourses"></tbody></table></div></div>
        </div>
        
        <div id="sims" class="content-section"><div class="header"><h2>Simuladores Cl√°sicos</h2><button class="btn-primary" onclick="openSimEditor('create')">+ Nuevo</button></div><div class="table-container"><div class="table-scroll"><table><thead><tr><th>T√≠tulo</th><th>Descripci√≥n</th><th>Acciones</th></tr></thead><tbody id="tbSims"></tbody></table></div></div></div>
        
        <div id="sims-editor" class="content-section"><div class="header"><h2>Editor de Escenarios</h2><div style="display:flex;gap:10px"><button class="btn-secondary" onclick="closeSimEditor()">Cancelar</button><button class="btn-primary" onclick="saveSim()">Guardar</button></div></div><div class="sim-editor"><div style="display:flex; gap:15px;"><input id="simTitle" class="form-control" placeholder="T√≠tulo"><input id="simDesc" class="form-control" placeholder="Descripci√≥n"></div><div id="stepsContainer" style="flex:1; overflow-y:auto; border-top:1px solid #eee; padding-top:10px"></div><button class="btn-primary" style="align-self:center" onclick="addStep()">+ Agregar Paso</button></div></div>
        
        <div id="exams" class="content-section"><div class="header"><h2>Ex√°menes</h2><button class="btn-primary" onclick="openModal('modalQuestion','create')">+ Pregunta</button></div><div class="table-container" style="padding:20px"><select id="selCourseEx" class="form-control" onchange="loadQuestions()" style="margin-bottom:15px"></select><table><thead><tr><th style="width: 50px"></th><th style="width: 60%">Pregunta</th><th style="width: 20%">Respuesta Correcta</th><th style="width: 15%">Acciones</th></tr></thead><tbody id="tbQuestions"></tbody></table></div></div>
        
        <div id="duels" class="content-section"><div class="header"><h2>PvP</h2></div><div class="table-container"><table><tbody id="tbDuels"></tbody></table></div></div>
    </div>

    <div class="modal-overlay" id="modalUser">
        <div class="modal-box">
            <h3>Gesti√≥n de Usuario</h3>
            <input type="hidden" id="uId">
            <div class="modal-grid">
                <div class="form-group"><label>Usuario</label><input id="uUser" class="form-control"></div>
                <div class="form-group"><label>DNI</label><input id="uDni" class="form-control"></div>
                <div class="form-group"><label>Nombre Completo</label><input id="uEmail" class="form-control"></div>
                <div class="form-group"><label>Contrase√±a</label><input id="uPass" class="form-control" placeholder="Dejar en blanco para no cambiar"></div>
                <div class="form-group"><label>Grupo</label><input id="uTag" class="form-control"></div>
                <div class="form-group">
                    <label>Tipo de Usuario</label>
                    <select id="uTipo" class="form-control">
                        <option value="capacitacion">Capacitaci√≥n</option>
                        <option value="trabajador">Trabajador</option>
                    </select>
                </div>
            </div>
            <div class="modal-section">
                <div class="modal-section-title"><i class="fas fa-briefcase"></i> Datos Operativos</div>
                <div class="modal-grid">
                    <div class="form-group"><label>Cartera</label><input id="uCartera" class="form-control"></div>
                    <div class="form-group"><label>Supervisor</label><input id="uSupervisor" class="form-control"></div>
                </div>
                <div class="form-group" style="margin-top:15px;">
                    <label>Observaci√≥n (Visible si no pasa)</label>
                    <textarea id="uObs" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveUser()">Guardar Cambios</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalAssign">
        <div class="modal-box">
            <h3>Asignar a <span id="assignTarget" style="color:var(--primary)"></span></h3>
            <div id="assignList" class="assign-container"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModals()">Cerrar</button>
                <button class="btn-primary" onclick="saveAssignments()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalCourse">
        <div class="modal-box">
            <h3>Material / Curso</h3>
            <input type="hidden" id="cId">
            <div class="form-group"><label>M√≥dulo</label><input id="cMod" class="form-control" placeholder="Ej: Negociaci√≥n"></div>
            <div class="form-group"><label>T√≠tulo</label><input id="cTitle" class="form-control" placeholder="Ej: Introducci√≥n"></div>
            
            <div class="form-group"><label>Tipo de Contenido</label>
                <select id="cType" class="form-control">
                    <option value="video">Video (YouTube/MP4)</option>
                    <option value="pdf">Documento (PDF)</option>
                    <option value="imagen">Imagen (JPG/PNG)</option>
                    <option value="examen">Examen (Te√≥rico)</option>
                </select>
            </div>

            <div class="form-group"><label>URL del Recurso (o sube un archivo abajo)</label><input id="cUrl" class="form-control" placeholder="https://..."></div>
            
            <div class="form-group">
                <label>Subir Archivo (Opcional)</label>
                <div class="file-input-wrapper">
                    <span id="fileNameDisplay"><i class="fas fa-cloud-upload-alt"></i> Clic aqu√≠ para seleccionar archivo</span>
                    <input type="file" id="cFile" onchange="updateFileName(this)">
                </div>
                <small style="color:#64748b">Soporta: MP4, PDF, PNG, JPG, PPTX, TXT</small>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModals()">Cancelar</button>
                <button id="btnSaveCourse" class="btn-primary" onclick="saveCourse()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalQuestion"><div class="modal-box"><h3>Pregunta</h3><input type="hidden" id="qId"><div class="form-group"><label>Pregunta</label><input id="qTxt" class="form-control"></div><div class="form-group"><label>Opci√≥n 1</label><input id="op1" class="form-control"></div><div class="form-group"><label>Opci√≥n 2</label><input id="op2" class="form-control"></div><div class="form-group"><label>Opci√≥n 3</label><input id="op3" class="form-control"></div><div class="form-group"><label>Correcta</label><select id="qCorrect" class="form-control"><option value="op1">Opci√≥n 1</option><option value="op2">Opci√≥n 2</option><option value="op3">Opci√≥n 3</option></select></div><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveQuestion()">Guardar</button></div></div></div>
    <div class="modal-overlay" id="modalConfigCalidad"><div class="modal-box" style="width:900px"><h3>Configuraci√≥n Calidad</h3><div class="form-group" style="background:#eef2ff; padding:15px; border-radius:8px;"><label>Asignar a Simulador:</label><select id="configScenarioSelect" class="form-control" onchange="loadCriteriaForSelectedScenario()"><option value="">Cargando...</option></select></div><div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px"><div style="display:grid; grid-template-columns: 1fr 2fr 0.5fr 40px; gap:10px; font-weight:700; color:#4f46e5; margin-bottom:10px; padding:0 10px"><span>Criterio</span><span>Instrucci√≥n IA</span><span>% Pts</span></div><div id="criteriaList" style="max-height:400px; overflow-y:auto; display:flex; flex-direction:column; gap:10px"></div></div><button class="btn-add-opt" onclick="addCriteriaRow()">+ Agregar</button><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveConfigCalidad()">Guardar</button></div></div></div>
    <div class="modal-overlay" id="modalEval"><div class="modal-box"><h3>Evaluaci√≥n Final</h3><input type="hidden" id="evalUserId"><div class="form-group"><label>Resultado</label><select id="evalStatus" class="form-control" onchange="toggleEvalFields()"><option value="">Seleccionar...</option><option value="Aprueba">Aprueba</option><option value="No Pasa">No Pasa</option></select></div><div class="form-group"><label>Observaci√≥n General</label><textarea id="evalObs" class="form-control" placeholder="Comentarios..."></textarea></div><div id="evalPassFields" style="display:none; padding:15px; background:#f0fdf4; border-radius:10px;"><h4 style="margin:0 0 10px 0; color:#166534">Datos</h4><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px"><div class="form-group"><label>Cartera</label><input id="evalCartera" class="form-control"></div><div class="form-group"><label>Supervisor</label><input id="evalSupervisor" class="form-control"></div></div><div class="form-group" style="margin-top:10px"><label><input type="checkbox" id="evalCert"> Certificado</label></div></div><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveEvaluation()">Guardar</button></div></div></div>
    <div class="modal-overlay" id="modalCalidad"><div class="modal-box" style="width:800px; background:#f8fafc"><div id="calidadDetalle"></div><div class="modal-actions" style="border-top:1px solid #e2e8f0; padding-top:15px"><button class="btn-secondary" onclick="closeModals()">Cerrar</button></div></div></div>
    <div class="modal-overlay" id="modalRoleplay"><div class="modal-box"><h3>Escenario IA</h3><input type="hidden" id="rpId"><div class="form-group"><label>T√≠tulo</label><input id="rpTitulo" class="form-control"></div><div class="form-group"><label>Prompt</label><textarea id="rpPrompt" class="form-control"></textarea></div><div style="background:#f8fafc;padding:15px;border-radius:10px;margin:15px 0"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><input id="rpCliNombre" class="form-control" placeholder="Nombre"><input id="rpCliProd" class="form-control" placeholder="Producto"><input id="rpCliDeuda" class="form-control" placeholder="Deuda"><input id="rpCliMora" class="form-control" placeholder="Mora"><input id="rpCliCapital" class="form-control" placeholder="Capital"><input id="rpCliCampana" class="form-control" placeholder="Campa√±a"></div></div><div class="form-group"><label>API Keys (Rotativas)</label><div id="apiKeysContainer" style="max-height:100px;overflow-y:auto;margin-bottom:10px"></div><button class="btn-add-opt" onclick="addApiKeyField()">+ Key</button><div class="modal-actions"><button class="btn-secondary" onclick="closeModals()">Cancelar</button><button class="btn-primary" onclick="saveRoleplay()">Guardar</button></div></div></div>

    <script>
        const SB_URL = 'https://xgvfcmadsprjyljtpooo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndmZjbWFkc3ByanlsanRwb29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODMxNjAsImV4cCI6MjA4MjE1OTE2MH0.XYBbKFE17PfyYMn2SNL5UJrCQmDRbimTQO0jpbX1Zd0';
        const sbClient = supabase.createClient(SB_URL, SB_KEY);
        let currentAssignUser='', editorSteps=[], currentSimId=null, usersDataForExcel=[];

        window.onload = () => { loadUsers(); loadCourses(); loadSims(); loadReports(); loadDuels(); loadExamCourses(); loadRoleplays(); };
        
        function nav(id, el) { 
            document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); 
            el.classList.add('active'); 
        }
        function closeModals(){ document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); }
        function openModal(id, mode){ 
            document.getElementById(id).style.display='flex'; 
            if(mode==='create'){ 
                if(id==='modalRoleplay') clearRoleplayForm(); 
                if(id==='modalCourse') clearCourseForm(); 
                if(id==='modalQuestion') clearQuestionForm(); 
                if(id==='modalUser') clearUserForm(); 
            } 
        }
        function logout(){ localStorage.clear(); window.location.href='index.html'; }

        // --- GESTI√ìN USUARIOS (CON RENOMBRAMIENTO DEL BOT√ìN ASIGNAR) ---
        async function loadUsers(){ 
            const {data}=await sbClient.from('usuarios').select('*').neq('rol','admin').order('id'); 
            usersDataForExcel = data.map(u => ({ "ID": u.id, "Usuario": u.usuario, "Nombre": u.correo || '', "DNI": u.dni, "Grupo": u.etiqueta, "Tipo": u.tipo || '', "Fecha Reg": new Date(u.created_at).toLocaleDateString(), "Estado": u.estado_capacitacion||'', "Cartera": u.cartera||'', "Supervisor": u.supervisor||'', "Obs": u.observacion||'' }));
            let h=''; 
            data.forEach(u=>{ 
                let stStyle = u.estado_capacitacion === 'Aprobado' ? 'background:#dcfce7;color:#166534' : (u.estado_capacitacion === 'Desaprobado' ? 'background:#fee2e2;color:#991b1b' : 'background:#f1f5f9;color:#64748b');
                let detalles = u.estado_capacitacion==='Aprobado' ? `<small style="display:block;color:#475569"><b>Cart:</b> ${u.cartera||'-'}</small><small style="display:block;color:#475569"><b>Sup:</b> ${u.supervisor||'-'}</small>` : (u.estado_capacitacion==='Desaprobado' ? `<small style="color:#ef4444;font-weight:600">${u.observacion||'Sin observaci√≥n'}</small>` : '-');
                
                // NOTA: Se cambi√≥ onclick="assign(...)" por "openAssignModal(...)" para evitar conflictos
                h+=`<tr>
                    <td><div style="font-weight:700; font-size:0.95rem; color:var(--text-main);">${u.correo || 'Sin Nombre'}</div><div style="font-size:0.8rem; color:var(--text-muted); margin-top:2px;"><i class="fas fa-user"></i> ${u.usuario} | <i class="fas fa-id-card"></i> ${u.dni}</div></td>
                    <td>${u.etiqueta}</td>
                    <td><span style="font-size:0.75rem;padding:2px 6px;border-radius:4px;background:#eef2ff;color:#4f46e5;font-weight:700;text-transform:uppercase">${u.tipo||'N/A'}</span></td>
                    <td style="font-size:0.85rem">${new Date(u.created_at).toLocaleDateString()}</td>
                    <td><span style="padding:4px 8px;border-radius:12px;font-size:0.75rem;font-weight:700;${stStyle}">${u.estado_capacitacion||'En Curso'}</span></td>
                    <td>${detalles}</td>
                    <td>
                        <button class="btn-icon btn-assign" onclick="openAssignModal('${u.usuario}')"><i class="fas fa-book"></i></button>
                        <button class="btn-icon btn-edit" onclick="editUser('${u.id}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon btn-delete" onclick="del('usuarios','${u.id}')"><i class="fas fa-trash"></i></button>
                        <button class="btn-icon btn-eval" onclick="openEvalModal('${u.id}')"><i class="fas fa-graduation-cap"></i></button>
                    </td>
                </tr>`; 
            }); 
            document.getElementById('tbUsers').innerHTML=h; 
        }

        // --- FUNCI√ìN ASIGNAR (CORREGIDA) ---
        async function openAssignModal(u){ 
            currentAssignUser = u; 
            document.getElementById('assignTarget').innerText = u; 
            openModal('modalAssign'); 
            
            // Verificaci√≥n de datos antes de pintar
            const {data:courses} = await sbClient.from('cursos').select('titulo, tipo'); 
            const {data:scenarios} = await sbClient.from('roleplay_scenarios').select('titulo'); 
            const {data:mine} = await sbClient.from('asignaciones').select('cursos_json').eq('usuario',u).maybeSingle(); 
            
            let my = (mine && mine.cursos_json) ? JSON.parse(mine.cursos_json) : []; 
            let h = ''; 
            
            if(courses) courses.forEach(c=>{ 
                let tag = c.tipo === 'simulador' ? '<span class="assign-tag tag-sim">Simulador</span>' : '<span class="assign-tag tag-course">Curso</span>'; 
                h+=`<label class="assign-item">
                        <div class="assign-label-box"><input type="checkbox" class="chk" value="${c.titulo}" ${my.includes(c.titulo)?'checked':''}> <span class="assign-label-text">${c.titulo}</span></div>
                        ${tag}
                    </label>`; 
            }); 
            if(scenarios) scenarios.forEach(s => { 
                h+=`<label class="assign-item">
                        <div class="assign-label-box"><input type="checkbox" class="chk" value="${s.titulo}" ${my.includes(s.titulo)?'checked':''}> <span class="assign-label-text">${s.titulo}</span></div>
                        <span class="assign-tag tag-ia">IA Roleplay</span>
                    </label>`; 
            }); 
            document.getElementById('assignList').innerHTML = h; 
        }

        async function saveAssignments(){ const l=Array.from(document.querySelectorAll('.chk:checked')).map(c=>c.value); const {data:ex}=await sbClient.from('asignaciones').select('id').eq('usuario',currentAssignUser).maybeSingle(); if(ex) await sbClient.from('asignaciones').update({cursos_json:JSON.stringify(l)}).eq('id',ex.id); else await sbClient.from('asignaciones').insert([{usuario:currentAssignUser,cursos_json:JSON.stringify(l)}]); alert('Asignado'); closeModals(); }

        async function editUser(id) {
            const { data } = await sbClient.from('usuarios').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('uId').value = data.id;
                document.getElementById('uUser').value = data.usuario;
                document.getElementById('uDni').value = data.dni;
                document.getElementById('uEmail').value = data.correo || '';
                document.getElementById('uTag').value = data.etiqueta;
                document.getElementById('uTipo').value = data.tipo || 'capacitacion';
                document.getElementById('uCartera').value = data.cartera || '';
                document.getElementById('uSupervisor').value = data.supervisor || '';
                document.getElementById('uObs').value = data.observacion || '';
                document.getElementById('uPass').value = ''; 
                openModal('modalUser');
            }
        }

        async function saveUser(){ 
            const id = document.getElementById('uId').value;
            const u = { usuario: document.getElementById('uUser').value, dni: document.getElementById('uDni').value, correo: document.getElementById('uEmail').value, etiqueta: document.getElementById('uTag').value, tipo: document.getElementById('uTipo').value, cartera: document.getElementById('uCartera').value, supervisor: document.getElementById('uSupervisor').value, observacion: document.getElementById('uObs').value };
            if(document.getElementById('uPass').value) u.password = document.getElementById('uPass').value;
            if(id) await sbClient.from('usuarios').update(u).eq('id',id); else { u.rol='asesor'; await sbClient.from('usuarios').insert([u]); }
            closeModals(); loadUsers(); 
        }
        function clearUserForm() { document.getElementById('uId').value=''; document.getElementById('uUser').value=''; document.getElementById('uDni').value=''; document.getElementById('uEmail').value=''; document.getElementById('uTag').value=''; document.getElementById('uCartera').value=''; document.getElementById('uSupervisor').value=''; document.getElementById('uObs').value=''; document.getElementById('uPass').value=''; }

        // --- MATERIALES / EXAMENES (FUNCIONES BLINDADAS) ---
        async function loadCourses(){ const {data}=await sbClient.from('cursos').select('*').neq('tipo','simulador'); let h=''; if(data) data.forEach(c=>{ h+=`<tr><td>${c.modulo}</td><td>${c.titulo}</td><td>${c.tipo}</td><td><button class="btn-icon btn-edit" onclick="editCourse('${c.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('cursos','${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbCourses').innerHTML=h; }
        
        function updateFileName(input) {
            const display = document.getElementById('fileNameDisplay');
            if (input.files.length > 0) {
                display.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i> ${input.files[0].name}`;
            } else {
                display.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Clic aqu√≠ para seleccionar archivo`;
            }
        }

        async function editCourse(id) { 
            const { data } = await sbClient.from('cursos').select('*').eq('id', id).single(); 
            if (data) { 
                document.getElementById('cId').value = data.id; document.getElementById('cMod').value = data.modulo; document.getElementById('cTitle').value = data.titulo; document.getElementById('cType').value = data.tipo; document.getElementById('cUrl').value = data.video || ''; openModal('modalCourse'); 
            } 
        }

        async function saveCourse() {
            const btn = document.getElementById('btnSaveCourse');
            btn.innerText = "Guardando..."; btn.disabled = true;

            try {
                const id = document.getElementById('cId').value;
                const fileInput = document.getElementById('cFile');
                let urlFinal = document.getElementById('cUrl').value;
                
                // SUBIDA DE ARCHIVO (Si se seleccion√≥ uno)
                if (fileInput.files.length > 0) {
                    btn.innerText = "Subiendo archivo...";
                    const file = fileInput.files[0];
                    const fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9.]/g, ''); // Limpiar nombre
                    
                    const { data, error } = await sbClient.storage.from('materiales').upload(fileName, file);
                    
                    if (error) throw error;
                    
                    const { data: publicData } = sbClient.storage.from('materiales').getPublicUrl(fileName);
                    urlFinal = publicData.publicUrl;
                }

                const courseData = { 
                    modulo: document.getElementById('cMod').value, 
                    titulo: document.getElementById('cTitle').value, 
                    tipo: document.getElementById('cType').value, 
                    video: urlFinal 
                };

                if (id) await sbClient.from('cursos').update(courseData).eq('id', id); 
                else await sbClient.from('cursos').insert([courseData]); 
                
                alert('Guardado exitosamente.');
                closeModals(); 
                loadCourses();
            } catch (error) {
                alert("Error: " + error.message);
                console.error(error);
            } finally {
                btn.innerText = "Guardar"; btn.disabled = false;
            }
        }

        function clearCourseForm() { document.getElementById('cId').value = ''; document.getElementById('cMod').value = ''; document.getElementById('cTitle').value = ''; document.getElementById('cType').value = 'video'; document.getElementById('cUrl').value = ''; document.getElementById('cFile').value = ''; document.getElementById('fileNameDisplay').innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Clic aqu√≠ para seleccionar archivo'; }

        async function loadExamCourses(){ const {data}=await sbClient.from('cursos').select('titulo'); const s=document.getElementById('selCourseEx'); s.innerHTML=''; if(data) data.forEach(c=>s.innerHTML+=`<option>${c.titulo}</option>`); loadQuestions(); }
        async function loadQuestions(){ const c=document.getElementById('selCourseEx').value; const {data}=await sbClient.from('preguntas').select('*').eq('curso',c); let h=''; if(data) data.forEach((q,index)=>{ h+=`<tr><td><button class="btn-toggle-row" onclick="toggleRow('row-${q.id}', this)"><i class="fas fa-chevron-down"></i></button></td><td>${q.pregunta}</td><td>${q.correcta}</td><td><button class="btn-icon btn-edit" onclick="editQuestion('${q.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('preguntas','${q.id}')"><i class="fas fa-trash"></i></button></td></tr><tr id="row-${q.id}" class="exam-detail-row"><td colspan="4"><div class="exam-detail-content"><div class="exam-opt"><strong>Opci√≥n 1</strong>${q.opcion1}</div><div class="exam-opt"><strong>Opci√≥n 2</strong>${q.opcion2}</div><div class="exam-opt"><strong>Opci√≥n 3</strong>${q.opcion3}</div></div></td></tr>`; }); document.getElementById('tbQuestions').innerHTML=h; }
        
        async function editQuestion(id){ 
            const {data} = await sbClient.from('preguntas').select('*').eq('id',id).single(); 
            if(data){ 
                document.getElementById('qId').value = data.id; document.getElementById('qTxt').value = data.pregunta; document.getElementById('op1').value = data.opcion1; document.getElementById('op2').value = data.opcion2; document.getElementById('op3').value = data.opcion3; document.getElementById('qCorrect').value = data.correcta; openModal('modalQuestion'); 
            } 
        }
        function clearQuestionForm(){ document.getElementById('qId').value=''; document.getElementById('qTxt').value=''; document.getElementById('op1').value=''; document.getElementById('op2').value=''; document.getElementById('op3').value=''; }
        async function saveQuestion(){ const id = document.getElementById('qId').value; const data = { curso:document.getElementById('selCourseEx').value, pregunta:document.getElementById('qTxt').value, opcion1:document.getElementById('op1').value, opcion2:document.getElementById('op2').value, opcion3:document.getElementById('op3').value, correcta:document.getElementById('qCorrect').value }; if(id) await sbClient.from('preguntas').update(data).eq('id',id); else await sbClient.from('preguntas').insert([data]); closeModals(); loadQuestions(); }

        // --- CALIDAD / OTROS ---
        async function openConfigCalidad() { const { data } = await sbClient.from('roleplay_scenarios').select('id, titulo'); const select = document.getElementById('configScenarioSelect'); select.innerHTML = '<option value="">Selecciona...</option>'; if(data) data.forEach(s => { select.innerHTML += `<option value="${s.id}">${s.titulo}</option>`; }); document.getElementById('criteriaList').innerHTML = '<p style="text-align:center;color:#999;padding:20px">Selecciona un simulador.</p>'; document.getElementById('modalConfigCalidad').style.display = 'flex'; }
        async function loadCriteriaForSelectedScenario() { const scenarioId = document.getElementById('configScenarioSelect').value; const list = document.getElementById('criteriaList'); list.innerHTML = ''; if(!scenarioId) return; const { data: scenarioData } = await sbClient.from('roleplay_scenarios').select('criterios').eq('id', scenarioId).single(); let criterios = []; if(scenarioData && scenarioData.criterios && scenarioData.criterios.length > 0) { criterios = scenarioData.criterios; } else { const { data: globalData } = await sbClient.from('config_calidad').select('criterios').limit(1).maybeSingle(); if (globalData && globalData.criterios) { criterios = globalData.criterios; } else { criterios = [{"nombre": "Saludo", "descripcion": "Saludo formal", "puntos": 20}]; } } criterios.forEach(c => addCriteriaRow(c.nombre, c.descripcion, c.puntos)); }
        function addCriteriaRow(name = "", desc = "", points = "") { const list = document.getElementById('criteriaList'); if(list.innerText.includes('Selecciona')) list.innerHTML = ''; const div = document.createElement('div'); div.className = 'key-row criteria-row'; div.style.gridTemplateColumns = "1fr 2fr 0.5fr 40px"; div.style.display = "grid"; div.innerHTML = `<input type="text" class="form-control c-name" value="${name}" placeholder="Criterio"><textarea class="form-control c-desc" rows="1" placeholder="Instrucci√≥n">${desc}</textarea><input type="number" class="form-control c-points" value="${points}" placeholder="%"><button class="btn-remove-key" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`; list.appendChild(div); }
        async function saveConfigCalidad() { const scenarioId = document.getElementById('configScenarioSelect').value; if(!scenarioId) return alert("Debes seleccionar un simulador."); const rows = document.querySelectorAll('.criteria-row'); const newCriteria = []; let totalPoints = 0; rows.forEach(r => { const name = r.querySelector('.c-name').value.trim(); const desc = r.querySelector('.c-desc').value.trim(); const points = parseInt(r.querySelector('.c-points').value.trim()) || 0; if(name) { newCriteria.push({ nombre: name, descripcion: desc, puntos: points }); totalPoints += points; } }); if(totalPoints !== 100) alert(`Aviso: Los puntos suman ${totalPoints}%.`); await sbClient.from('roleplay_scenarios').update({ criterios: newCriteria }).eq('id', scenarioId); alert('Criterios guardados.'); closeModals(); }
        async function loadCalidadData() { const { data } = await sbClient.from('sesiones_roleplay').select('*').order('created_at', {ascending:false}); let h = ''; if(data) data.forEach(item => { const isPass = item.puntaje_total >= 70; const statusClass = isPass ? 'pass' : 'fail'; const det = JSON.stringify(item.detalle_json).replace(/"/g, '&quot;'); h += `<div class="calidad-card ${statusClass}" onclick="verDetalleCalidad('${det}', ${item.puntaje_total})"><div class="c-user">${item.usuario}</div><span class="c-date">${new Date(item.created_at).toLocaleString()}</span><div class="c-score">${item.puntaje_total}%</div><div class="c-tag">${item.escenario || 'Roleplay'}</div></div>`; }); document.getElementById('calidadGrid').innerHTML = h; }
        function verDetalleCalidad(jsonStr, score) { const data = JSON.parse(jsonStr); let colorScore = score >= 70 ? 'var(--success)' : 'var(--danger)'; let html = `<div class="q-header"><div><h4 style="color:#64748b;margin:0;text-transform:uppercase;font-size:0.9rem">Nota Final</h4><div class="q-score-big" style="color:${colorScore}">${score}%</div></div></div>`; html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px"><div style="background:#f0fdf4; padding:10px; border-radius:8px; border:1px solid #bbf7d0"><strong style="color:#166534">‚úÖ Fortalezas</strong><ul style="margin:5px 0 0 20px; color:#14532d; font-size:0.85rem">`; if(data.fortalezas) data.fortalezas.forEach(f => html += `<li>${f}</li>`); else html += `<li>Sin datos</li>`; html += `</ul></div><div style="background:#fef2f2; padding:10px; border-radius:8px; border:1px solid #fecaca"><strong style="color:#991b1b">‚ö†Ô∏è A mejorar</strong><ul style="margin:5px 0 0 20px; color:#7f1d1d; font-size:0.85rem">`; if(data.areas_mejora) data.areas_mejora.forEach(m => html += `<li>${m}</li>`); else html += `<li>Sin datos</li>`; html += `</ul></div></div>`; if(data.mejoras && data.mejoras.length > 0) { html += `<div class="q-improvements-section"><h4 style="margin:0 0 15px 0; color:#475569">üîç An√°lisis T√©cnico</h4>`; data.mejoras.forEach(m => { html += `<div class="q-imp-card"><div class="q-imp-title"><i class="fas fa-search"></i> ${m.criterio}</div><div class="q-error-box">"${m.error_cita}"</div><div class="q-suggestion-box"><span class="q-tech-label">${m.tecnica_sugerida}</span><div><strong style="font-size:0.8rem">Sugerencia:</strong> "${m.ejemplo_script}"</div></div></div>`; }); html += `</div>`; } document.getElementById('calidadDetalle').innerHTML = html; document.getElementById('modalCalidad').style.display = 'flex'; }
        async function loadReports(){ const {data: evals} = await sbClient.from('evaluaciones').select('*').order('created_at',{ascending:false}); const {data: users} = await sbClient.from('usuarios').select('usuario, correo'); const userMap = {}; if(users) users.forEach(u => userMap[u.usuario] = u.correo || ''); reportDataForExcel = []; let h=''; if(evals) evals.forEach(r=>{ const btn = r.retest_active ? '<span style="color:var(--success);font-weight:700">Retest Activo</span>' : `<button class="btn-retest" onclick="retest('${r.id}')"><i class="fas fa-sync"></i> Retest</button>`; const nombreCompleto = userMap[r.usuario] || '-'; reportDataForExcel.push({ "Fecha": new Date(r.created_at).toLocaleDateString(), "Usuario": r.usuario, "Nombre": nombreCompleto, "Curso": r.curso, "Nota": r.nota }); const det = r.detalle ? formatDetails(r.detalle) : '<span style="color:#999">Sin detalle</span>'; const rowId = `detail-${r.id}`; h+=`<tr><td><button class="btn-toggle-row" onclick="toggleDetail('${rowId}', this)"><i class="fas fa-chevron-down"></i></button></td><td>${new Date(r.created_at).toLocaleDateString()}</td><td><b>${r.usuario}</b><br><small style="color:#64748b">${nombreCompleto}</small></td><td>${r.curso}</td><td>${r.grupo||'-'}</td><td><span style="font-weight:800; color:${r.nota>=14?'var(--success)':'var(--danger)'}">${r.nota}</span></td><td style="display:flex; gap:10px;"><button class="btn-certify" onclick="cert('${r.usuario}','${r.curso}')"><i class="fas fa-certificate"></i> Certificar</button>${btn}</td></tr><tr id="${rowId}" class="detail-row"><td colspan="7"><div class="detail-content">${det}</div></td></tr>`; }); document.getElementById('tbReports').innerHTML=h; }
        function toggleDetail(id, btn) { const row = document.getElementById(id); if (row.style.display === "table-row") { row.style.display = "none"; btn.classList.remove("rotated"); } else { row.style.display = "table-row"; btn.classList.add("rotated"); } }
        function formatDetails(txt) { let parts = txt.split(" ||| "); let incorrects = parts.filter(p => p.includes("INCORRECTO")); if(incorrects.length === 0) return '<span style="color:green">Examen perfecto</span>'; return incorrects.map(inc => `<div class="incorrect-item"><i class="fas fa-times-circle"></i> ${inc.replace('[','').replace(']','').replace('(INCORRECTO)','')}</div>`).join(''); }
        function exportToExcel(){ if(reportDataForExcel.length===0) return alert("No hay datos"); const ws = XLSX.utils.json_to_sheet(reportDataForExcel); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Reporte"); XLSX.writeFile(wb, 'Reporte.xlsx'); }
        async function loadRoleplays() { const { data } = await sbClient.from('roleplay_scenarios').select('*').order('id'); let h = ''; if(data) data.forEach(r => { let d = r.datos_cliente || {}; let k = r.api_keys ? r.api_keys.length : 0; h += `<tr><td><b>${r.titulo}</b></td><td>${d.nombre||'-'}</td><td>${d.deuda||'-'}</td><td><span style="background:#e0e7ff;padding:2px 5px;border-radius:5px">${k} Keys</span></td><td><button class="btn-icon btn-edit" onclick="editRoleplay('${r.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('roleplay_scenarios','${r.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbRoleplays').innerHTML = h; }
        function addApiKeyField(value = "") { const container = document.getElementById('apiKeysContainer'); const div = document.createElement('div'); div.className = 'key-row'; div.innerHTML = `<input type="text" class="form-control key-input" value="${value}" placeholder="sk-..."><button class="btn-remove-key" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`; container.appendChild(div); }
        async function saveRoleplay() { const id = document.getElementById('rpId').value; const keys = []; document.querySelectorAll('.key-input').forEach(input => { if(input.value.trim()) keys.push(input.value.trim()); }); const data = { titulo: document.getElementById('rpTitulo').value, prompt_sistema: document.getElementById('rpPrompt').value, datos_cliente: { nombre: document.getElementById('rpCliNombre').value, producto: document.getElementById('rpCliProd').value, deuda: document.getElementById('rpCliDeuda').value, mora: document.getElementById('rpCliMora').value, capital: document.getElementById('rpCliCapital').value, campana: document.getElementById('rpCliCampana').value }, api_keys: keys }; if(id) await sbClient.from('roleplay_scenarios').update(data).eq('id', id); else await sbClient.from('roleplay_scenarios').insert([data]); closeModals(); loadRoleplays(); }
        async function editRoleplay(id) { const { data } = await sbClient.from('roleplay_scenarios').select('*').eq('id', id).single(); if(data) { document.getElementById('rpId').value = data.id; document.getElementById('rpTitulo').value = data.titulo; document.getElementById('rpPrompt').value = data.prompt_sistema; let d = data.datos_cliente || {}; document.getElementById('rpCliNombre').value = d.nombre || ''; document.getElementById('rpCliProd').value = d.producto || ''; document.getElementById('rpCliDeuda').value = d.deuda || ''; document.getElementById('rpCliMora').value = d.mora || ''; document.getElementById('rpCliCapital').value = d.capital || ''; document.getElementById('rpCliCampana').value = d.campana || ''; const container = document.getElementById('apiKeysContainer'); container.innerHTML = ''; if(data.api_keys && data.api_keys.length > 0) { data.api_keys.forEach(k => addApiKeyField(k)); } else { addApiKeyField(); } openModal('modalRoleplay'); } }
        function clearRoleplayForm() { document.getElementById('rpId').value = ''; document.getElementById('rpTitulo').value = ''; document.getElementById('rpPrompt').value = ''; document.getElementById('rpCliNombre').value = ''; document.getElementById('rpCliProd').value = ''; document.getElementById('rpCliDeuda').value = ''; document.getElementById('rpCliMora').value = ''; document.getElementById('rpCliCapital').value = ''; document.getElementById('rpCliCampana').value = ''; document.getElementById('apiKeysContainer').innerHTML = ''; addApiKeyField(); }
        async function loadSims(){ const {data}=await sbClient.from('cursos').select('*').eq('tipo','simulador'); let h=''; if(data) data.forEach(s=>{ h+=`<tr><td>${s.titulo}</td><td>${s.descripcion}</td><td><button class="btn-icon btn-edit" onclick="editSim('${s.id}')"><i class="fas fa-pen"></i></button><button class="btn-icon btn-delete" onclick="del('cursos','${s.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tbSims').innerHTML=h; }
        function openSimEditor(mode){ document.getElementById('sims').style.display='none'; document.getElementById('sims-editor').style.display='flex'; if(mode==='create'){ currentSimId=null; editorSteps=[{cliente:"Hola...", opciones:["Respuesta A"], correcta:0}]; document.getElementById('simTitle').value=''; document.getElementById('simDesc').value=''; renderSteps(); } }
        async function editSim(id){ const {data}=await sbClient.from('cursos').select('*').eq('id',id).single(); currentSimId=id; document.getElementById('simTitle').value=data.titulo; document.getElementById('simDesc').value=data.descripcion; editorSteps=JSON.parse(data.data_juego); document.getElementById('sims').style.display='none'; document.getElementById('sims-editor').style.display='flex'; renderSteps(); }
        function closeSimEditor(){ document.getElementById('sims-editor').style.display='none'; document.getElementById('sims').style.display='flex'; }
        function renderSteps(){ let h=''; editorSteps.forEach((s, i) => { let optsHtml = ''; s.opciones.forEach((opt, j) => { optsHtml += `<div style="display:flex; gap:5px; margin-bottom:5px; align-items:center"><input type="radio" name="corr${i}" ${s.correcta==j?'checked':''} onclick="updateStep(${i},'correcta',${j})"><input class="form-control" value="${opt}" oninput="updateOpt(${i},${j},this.value)" placeholder="Opci√≥n ${j+1}"><button class="btn-icon" style="background:#ef4444; width:25px; height:25px" onclick="removeOpt(${i},${j})"><i class="fas fa-times"></i></button></div>`; }); h += `<div class="step-card"><h4>Paso ${i + 1}</h4><i class="fas fa-trash delete-step" onclick="removeStep(${i})"></i><div class="form-group"><label>Cliente Dice:</label><input class="form-control" value="${s.cliente}" oninput="updateStep(${i}, 'cliente', this.value)"></div><div class="form-group"><label>Respuestas:</label>${optsHtml}<button class="btn-add-opt" onclick="addOpt(${i})">+ Agregar Opci√≥n</button></div></div>`; }); document.getElementById('stepsContainer').innerHTML = h; }
        function addStep(){ editorSteps.push({cliente: "...", opciones: ["Opci√≥n 1"], correcta: 0}); renderSteps(); }
        function removeStep(i){ editorSteps.splice(i, 1); renderSteps(); }
        function updateStep(i, f, v){ editorSteps[i][f] = v; }
        function updateOpt(i, j, v){ editorSteps[i].opciones[j] = v; }
        function addOpt(stepIndex) { editorSteps[stepIndex].opciones.push(""); renderSteps(); }
        function removeOpt(stepIndex, optIndex) { if(editorSteps[stepIndex].opciones.length <= 1) return alert("M√≠nimo una opci√≥n."); editorSteps[stepIndex].opciones.splice(optIndex, 1); if(editorSteps[stepIndex].correcta >= editorSteps[stepIndex].opciones.length) editorSteps[stepIndex].correcta = 0; renderSteps(); }
        async function saveSim(){ const s = { titulo: document.getElementById('simTitle').value, descripcion: document.getElementById('simDesc').value, modulo: 'Entrenamiento', tipo: 'simulador', data_juego: JSON.stringify(editorSteps), categoria: 'General' }; if(currentSimId) await sbClient.from('cursos').update(s).eq('id',currentSimId); else await sbClient.from('cursos').insert([s]); alert('Guardado'); closeSimEditor(); loadSims(); }
        async function loadDuels(){ const {data}=await sbClient.from('duelos').select('*'); let h=''; if(data) data.forEach(d=>h+=`<tr><td>${new Date(d.created_at).toLocaleDateString()}</td><td>${d.retador} vs ${d.oponente}</td><td>${d.score_retador||0}-${d.score_oponente||0}</td><td>${d.estado}</td></tr>`); document.getElementById('tbDuels').innerHTML=h; }
        let currentEvalUserId = ''; async function openEvalModal(uid) { currentEvalUserId = uid; document.getElementById('evalStatus').value = ''; document.getElementById('evalObs').value = ''; document.getElementById('evalCartera').value = ''; document.getElementById('evalSupervisor').value = ''; document.getElementById('evalCert').checked = false; toggleEvalFields(); const { data } = await sbClient.from('usuarios').select('*').eq('id', uid).single(); if(data) { if(data.estado_capacitacion === 'Aprobado') document.getElementById('evalStatus').value = 'Aprueba'; else if(data.estado_capacitacion === 'Desaprobado') document.getElementById('evalStatus').value = 'No Pasa'; document.getElementById('evalObs').value = data.observacion || ''; document.getElementById('evalCartera').value = data.cartera || ''; document.getElementById('evalSupervisor').value = data.supervisor || ''; toggleEvalFields(); } openModal('modalEval'); } function toggleEvalFields() { const val = document.getElementById('evalStatus').value; document.getElementById('evalPassFields').style.display = (val === 'Aprueba') ? 'block' : 'none'; } async function saveEvaluation() { const status = document.getElementById('evalStatus').value; const obs = document.getElementById('evalObs').value; if(!status) return alert("Selecciona un resultado."); let updates = { estado_capacitacion: status === 'Aprueba' ? 'Aprobado' : 'Desaprobado', observacion: obs }; if (status === 'Aprueba') { updates.cartera = document.getElementById('evalCartera').value; updates.supervisor = document.getElementById('evalSupervisor').value; if (document.getElementById('evalCert').checked) { const { data: u } = await sbClient.from('usuarios').select('certificados_json').eq('id', currentEvalUserId).single(); let certs = u.certificados_json ? JSON.parse(u.certificados_json) : []; if (!certs.includes("CAPACITACION FINALIZADA")) { certs.push("CAPACITACION FINALIZADA"); updates.certificados_json = JSON.stringify(certs); } } } else { updates.cartera = null; updates.supervisor = null; } await sbClient.from('usuarios').update(updates).eq('id', currentEvalUserId); alert("Evaluaci√≥n guardada."); closeModals(); loadUsers(); } function exportUsersToExcel() { if(usersDataForExcel.length === 0) return alert("No hay usuarios"); const ws = XLSX.utils.json_to_sheet(usersDataForExcel); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Usuarios"); XLSX.writeFile(wb, 'Usuarios_Geincos.xlsx'); }
        async function del(t,id){ if(confirm('Eliminar?')) { await sbClient.from(t).delete().eq('id',id); if(t==='roleplay_scenarios') loadRoleplays(); else if(t==='preguntas') loadQuestions(); else if(t==='cursos') loadCourses(); else location.reload(); } }
    </script>
</body>
</html>